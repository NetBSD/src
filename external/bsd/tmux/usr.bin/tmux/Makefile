# $NetBSD: Makefile,v 1.36 2024/06/23 06:27:38 wiz Exp $

.include <bsd.own.mk>

SRCDIR=		${NETBSDSRCDIR}/external/bsd/tmux/dist
.PATH:		${SRCDIR}
.PATH:		${SRCDIR}/compat

BINDIR=		/usr/bin
PROG=		tmux
MAN=		tmux.1

WARNS?=	4

SRCS+= \
alerts.c \
arguments.c \
attributes.c \
cfg.c \
client.c \
cmd-attach-session.c \
cmd-bind-key.c \
cmd-break-pane.c \
cmd-capture-pane.c \
cmd-choose-tree.c \
cmd-command-prompt.c \
cmd-confirm-before.c \
cmd-copy-mode.c \
cmd-detach-client.c \
cmd-display-menu.c \
cmd-display-message.c \
cmd-display-panes.c \
cmd-find-window.c \
cmd-find.c \
cmd-if-shell.c \
cmd-join-pane.c \
cmd-kill-pane.c \
cmd-kill-server.c \
cmd-kill-session.c \
cmd-kill-window.c \
cmd-list-buffers.c \
cmd-list-clients.c \
cmd-list-keys.c \
cmd-list-panes.c \
cmd-list-sessions.c \
cmd-list-windows.c \
cmd-load-buffer.c \
cmd-lock-server.c \
cmd-move-window.c \
cmd-new-session.c \
cmd-new-window.c \
cmd-parse.y \
cmd-paste-buffer.c \
cmd-pipe-pane.c \
cmd-queue.c \
cmd-refresh-client.c \
cmd-rename-session.c \
cmd-rename-window.c \
cmd-resize-pane.c \
cmd-resize-window.c \
cmd-respawn-pane.c \
cmd-respawn-window.c \
cmd-rotate-window.c \
cmd-run-shell.c \
cmd-save-buffer.c \
cmd-select-layout.c \
cmd-select-pane.c \
cmd-select-window.c \
cmd-send-keys.c \
cmd-server-access.c \
cmd-set-buffer.c \
cmd-set-environment.c \
cmd-set-option.c \
cmd-show-environment.c \
cmd-show-messages.c \
cmd-show-options.c \
cmd-show-prompt-history.c \
cmd-source-file.c \
cmd-split-window.c \
cmd-swap-pane.c \
cmd-swap-window.c \
cmd-switch-client.c \
cmd-unbind-key.c \
cmd-wait-for.c \
cmd.c \
colour.c \
control-notify.c \
control.c \
environ.c \
file.c \
format-draw.c \
format.c \
grid-reader.c \
grid-view.c \
grid.c \
hyperlinks.c \
image.c \
image-sixel.c \
input-keys.c \
input.c \
job.c \
key-bindings.c \
key-string.c \
layout-custom.c \
layout-set.c \
layout.c \
log.c \
menu.c \
mode-tree.c \
names.c \
notify.c \
options-table.c \
options.c \
osdep-netbsd.c \
paste.c \
popup.c \
proc.c \
regsub.c \
resize.c \
screen-redraw.c \
screen-write.c \
screen.c \
server-acl.c \
server-client.c \
server-fn.c \
server.c \
session.c \
spawn.c \
status.c \
style.c \
tmux.c \
tty-acs.c \
tty-features.c \
tty-keys.c \
tty-term.c \
tty.c \
utf8.c \
utf8-combined.c \
window-buffer.c \
window-client.c \
window-clock.c \
window-copy.c \
window-customize.c \
window-tree.c \
window.c \
xmalloc.c

SRCS+=	utempter.c
CPPFLAGS+=-DSUPPORT_UTMP -DSUPPORT_UTMPX

# Files in compat/
SRCS+=		imsg-buffer.c
SRCS+=		imsg.c
SRCS+=		fdforkpty.c
SRCS+=		freezero.c
SRCS+=		explicit_bzero.c
SRCS+=		htonll.c
SRCS+=		ntohll.c
SRCS+=		recallocarray.c
SRCS+=		getdtablecount.c
#SRCS+=		strtonum.c
#SRCS+=		unvis.c
#SRCS+=		vis.c

CPPFLAGS+=	-I${SRCDIR} -I${.CURDIR}

# The following flags have been extracted from the compiler command-line
# generated by Automake and Autoconf when building tmux under NetBSD.
# Would be nicer to stick this in a config.h file, but the upstream code
# does not use one at this moment.

# HAVE_REALLOCARRAY, HAVE_TREE_H, HAVE_VIS added manually
#
# HAVE_BSD_GETOPT:
# Use the NetBSD libc getopt functions instead of the compat functions
# provided by tmux (done using a local patch).
#
# HAVE_VIS:
# tmux assumes the OpenBSD variant of strnvis which has arguments
# swapped compared to FreeBSD & NetBSD, see
# https://github.com/tmux/tmux/pull/4015
# We have a local patch that adapts the call to the NetBSD version,
# so we don't need to use the compat code provided by tmux.
CPPFLAGS+=	\
-DHAVE_ASPRINTF=1 \
-DHAVE_B64_NTOP=1 \
-DHAVE_BITSTRING_H=1 \
-DHAVE_BSD_GETOPT=1 \
-DHAVE_CFMAKERAW=1 \
-DHAVE_CLOCK_GETTIME=1 \
-DHAVE_CLOSEFROM=1 \
-DHAVE_CURSES_H=1 \
-DHAVE_DAEMON=1 \
-DHAVE_DIRENT_H=1 \
-DENABLE_SIXEL=1 \
-DHAVE_EVENT2_EVENT_H=1 \
-DHAVE_FCNTL_CLOSEM=1 \
-DHAVE_FCNTL_H=1 \
-DHAVE_FGETLN=1 \
-DHAVE_FLOCK=1 \
-DHAVE_FORKPTY=1 \
-DHAVE_GETDTABLESIZE=1 \
-DHAVE_GETLINE=1 \
-DHAVE_GETPEEREID=1 \
-DHAVE_GETPROGNAME=1 \
-DHAVE_INTTYPES_H=1 \
-DHAVE_LIBM=1 \
-DHAVE_LIBPROC_H=1 \
-DHAVE_MEMMEM=1 \
-DHAVE_MEMORY_H=1 \
-DHAVE_PATHS_H=1 \
-DHAVE_PROC_PID=1 \
-DHAVE_QUEUE_H=1 \
-DHAVE_REALLOCARRAY=1 \
-DHAVE_SETENV=1 \
-DHAVE_SETPROCTITLE=1 \
-DHAVE_STDINT_H=1 \
-DHAVE_STDLIB_H=1 \
-DHAVE_STRCASESTR=1 \
-DHAVE_STRINGS_H=1 \
-DHAVE_STRING_H=1 \
-DHAVE_STRLCAT=1 \
-DHAVE_STRLCPY=1 \
-DHAVE_STRNDUP=1 \
-DHAVE_STRSEP=1 \
-DHAVE_STRTONUM=1 \
-DHAVE_SYSCONF=1 \
-DHAVE_SYS_DIR_H=1 \
-DHAVE_SYS_SIGNAME=1 \
-DHAVE_SYS_STAT_H=1 \
-DHAVE_SYS_TREE_H=1 \
-DHAVE_SYS_TYPES_H=1 \
-DHAVE_TIPARM=1 \
-DHAVE_TREE_H=1 \
-DHAVE_UNISTD_H=1 \
-DHAVE_UTIL_H=1 \
-DHAVE_VIS=1 \
-DHAVE___PROGNAME=1 \
-DPACKAGE=\"tmux\" \
-DPACKAGE_BUGREPORT=\"\" \
-DPACKAGE_NAME=\"tmux\" \
-DPACKAGE_STRING=\"tmux\ 3.4\" \
-DPACKAGE_TARNAME=\"tmux\" \
-DPACKAGE_URL=\"\" \
-DPACKAGE_VERSION=\"3.4\" \
-DSTDC_HEADERS=1 \
-DTMUX_CONF='"/etc/tmux.conf:~/.tmux.conf:$XDG_CONFIG_HOME/tmux/tmux.conf:~/.config/tmux/tmux.conf"' \
-DTMUX_LOCK_CMD='"lock -np"' \
-DTMUX_TERM='"tmux-256color"' \
-DTMUX_VERSION='"3.4"' \
-DVERSION=\"3.4\" \
-D_ALL_SOURCE=1 \
-D_GNU_SOURCE=1 \
-D_OPENBSD_SOURCE \
-D_POSIX_PTHREAD_SEMANTICS=1 \
-D_TANDEM_SOURCE=1 \
-D__EXTENSIONS__=1

LDADD+=		-levent -lterminfo -lutil -lm
DPADD+=		${LIBEVENT} ${LIBTERMINFO} ${LIBUTIL}

COPTS.format.c += -Wno-format-nonliteral
COPTS.input.c += -Wno-sign-compare -Wno-pointer-sign
COPTS.tty.c += -Wno-pointer-sign
COPTS.utempter.c+=	${CC_WNO_STRINGOP_TRUNCATION}
COPTS.window-copy.c+=	${CC_WNO_MAYBE_UNINITIALIZED} -Wno-pointer-sign

# The man page needs substitutions, but the dist file usurps the
# output file suffix.
.NOPATH: tmux.1
tmux.1: $(SRCDIR)/tmux.1
	sed -e 's|@SYSCONFDIR@|/etc|g' $> > $@

CLEANDIRFILES+=	tmux.1

.include <bsd.prog.mk>
