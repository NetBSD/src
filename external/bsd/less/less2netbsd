#!/bin/sh
#
#	$NetBSD: less2netbsd,v 1.6 2023/10/06 05:58:21 simonb Exp $
#
# Copyright (c) 2011 The NetBSD Foundation, Inc.
# All rights reserved.
#
# This code is derived from software contributed to The NetBSD Foundation
# by Matthias Scheler.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS
# ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
# TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
# PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS
# BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
# CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
# SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
# INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
# CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
# ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
# POSSIBILITY OF SUCH DAMAGE.
#

# less2netbsd: Prepare a less source tree for import into the NetBSD
# source repository, under src/external .
# based on many other *2netbsd scripts
#
# Rough instructions for importing new less release:
#
#	$ cd /some/where/temporary
#	$ tar xpfz /new/less/release/tar/file
#	$ sh /usr/src/external/bsd/less/less2netbsd less-xyz `pwd`
#	$ cd src/external/bsd/less/dist
#	$ cvs -d cvs.netbsd.org:/cvsroot import src/external/bsd/less/dist \
#		GREENWOODSOFTWARE LESS-xyz
#	   Enter the new NEWS portion as your commit message
#	$ cd ../../../../../less-xyz
#	$ ./configure
#	$ cp defines.h /usr/src/external/bsd/less/include
#	$ cd /usr/src/external/bsd/less
#	$ cvs update
#	$ cvs commit -m "Updated autoconf generated files for less xyz."
#	$ cd /some/where/temporary
#	   ... and clean up the leftovers

PROGNAME=$(basename "$0")
if [ $# -ne 2 ]; then
	echo "Usage: $PROGNAME src dest" >&2
	exit 1
fi

r=$1
d=$2/src/external/bsd/less/dist

case "$d" in
	/*)
		;;
	*)
		d=`/bin/pwd`/$d
		;;
esac

case "$r" in
	/*)
		;;
	*)
		r=`/bin/pwd`/$r
		;;
esac

# Start with clean target directory
echo preparing directory $d
rm -rf $d
mkdir -p $d

# Change to the source directory.
if [ -d $r ] && cd $r; then
	:
else
	echo "${PROGNAME}: cannot access directory \"$r\"." >&2
	exit 1
fi

# Copy the files and directories
echo copying $r to $d
cd $r
pax -rwpp * $d

# Check whether the source directory looks sane.
CHECK_FILES="LICENSE configure less.h version.c"
for FILENAME in $CHECK_FILES; do
	if [ ! -f "$FILENAME" ]; then
		echo "${PROGNAME}: less distribution incomplete." >&2
		exit
	fi
done

# Check whether the "configure" was run.
REQUIRED_HEADERS=defines.h
for FILENAME in $REQUIRED_HEADERS
do
	if [ -f "$FILENAME" ]; then
		echo "${PROGNAME}: \"./configure\" run too early, start again." >&2
		exit 1
	fi
done

# Fix the permissions.
find . -type d -printx | xargs chmod 755
find . -type f -printx | xargs chmod 644
chmod 755 configure

# Remove files generated by "configure".
REMOVE_FILES="Makefile config.log config.status"
rm -f $REMOVE_FILES

# Remove extra files/dirs that we don't want to import
rm -rf lesstest

# Add NetBSD RCS Ids.
find . -type f -name "*.[ch]" -print |
while read FILENAME
do
	if ! grep -q '\$NetBSD' "$FILENAME"; then
		NEW_FILENAME="${FILENAME}.new"
		rm -f "${NEW_FILENAME}"
		(echo "/*	\$NetBSD\$	*/"
		 echo ""
		 cat "$FILENAME") >"${NEW_FILENAME}"
		mv -f "${NEW_FILENAME}" "$FILENAME"
	fi
done

# Remove formatted manual pages.
find . -type f -name "*.man" -delete

# Rename unformatted manual pages.
find . -type f -name "*.nro" -print |
while read FILENAME
do
	mv "$FILENAME" "${FILENAME%.nro}.1"
done

# Determine the version number.
VERSION=$(sed -n -e 's#char version\[\] = "\(.*\)";#\1#p' version.c)

# Print out information for the import.
cat <<EOF
You can import now.

Path:		src/external/bsd/less/dist
Vendortag:	GREENWOODSOFTWARE
Releasetag:	LESS-$VERSION
EOF

exit 0
