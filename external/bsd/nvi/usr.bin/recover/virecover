#!/bin/sh -
#
#	$NetBSD: virecover,v 1.2 2017/11/04 05:43:18 christos Exp $
#
#	@(#)recover.in	8.8 (Berkeley) 10/10/96
#
# Script to recover nvi edit sessions.

RECDIR="/var/tmp/vi.recover"
SENDMAIL="/usr/sbin/sendmail"

# Check editor backup files.
for i in $RECDIR/vi.*; do
	# Only test files that are readable.
	if [ \( ! -f "$i" \) -o \( ! -r "$i" \) ]; then
		continue
	fi

	# Unmodified nvi editor backup files either have the
	# execute bit set or are zero length.  Delete them.
	if [ \( -x "$i" \) -o \( -z "$i" \) ]; then
		rm -f "$i"
	fi
done

# It is possible to get incomplete recovery files, if the editor crashes
# at the right time.
for i in $RECDIR/recover.*; do
	# Only test files that are readable.
	if [ ! -r "$i" ]; then
		continue
	fi

	# Delete any recovery files that are zero length, corrupted,
	# or that have no corresponding backup file.  Else send mail
	# to the user.
	recfile=$(awk '/^X-vi-recover-path:/{print $2}' < "$i")
	if [ \( -n "$recfile" \) -a \( -s "$recfile" \); then
		$SENDMAIL -t < "$i"
	else
		rm -f "$i"
	fi
done
