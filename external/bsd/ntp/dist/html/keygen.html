<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>

<head>
<meta http-equiv="content-type" content="text/html;charset=iso-8859-1">
<meta name="generator" content="HTML Tidy, see www.w3.org">
<title>ntp-keygen - generate public and private keys</title>
<link href="scripts/style.css" type="text/css" rel="stylesheet">
</head>

<body>
<h3><tt>ntp-keygen</tt> - generate public and private keys</h3>

<p><img src="pic/alice23.gif" alt="gif" align="left"><a href="http://www.eecis.udel.edu/%7emills/pictures.html">from <i>Alice's Adventures in Wonderland</i>, Lewis Carroll</a></p>

<p>Alice holds the key.</p>

<p>Last update: 
	<!-- #BeginDate format:En2m -->13-Nov-2009  0:44<!-- #EndDate -->
</p>
<br clear="left">

<h4>Related Links</h4>
<script type="text/javascript" language="javascript" src="scripts/manual.txt"></script>

<h4>Table of Contents</h4>

<ul>

<li class="inline"><a href="#synop">Synopsis</a></li>
<li class="inline"><a href="#descrip">Description</a></li>
<li class="inline"><a href="#run">Running the program</a></li>
<li class="inline"><a href="#trust">Trusted Hosts and Secure Groups</a></li>
<li class="inline"><a href="#ident">Identity Schemes</a></li>
<li class="inline"><a href="#cmd">Command Line Options</a></li>
<li class="inline"><a href="#rand">Random Seed File</a></li>
<li class="inline"><a href="#fmt">Cryptographic Data Files</a></li>
<li class="inline"><a href="#bug">Bugs</a></li>
</ul>

<hr>

<h4 id="synop">Synopsis</h4>

<p id="intro"><tt>ntp-keygen [ -deGHIMPT ] [ -c [RSA-MD2 | RSA-MD5 | RSA-SHA
		| RSA-SHA1 | RSA-MDC2 | RSA-RIPEMD160 | DSA-SHA | DSA-SHA1 ] ] [
		-i <i>group</i> ]
		[ -m <i>modulus</i> ]  [ -p <i>passwd2</i> ] [ -q <i>passwd1</i> ] [ -S
		[ RSA | DSA ] ] [ -s <i>host</i> ] [ -V <i>nkeys</i> ]</tt></p>

<h4 id="descrip">Description</h4>

<p>This program generates cryptographic data files used by the NTPv4 authentication
	and identity schemes. It can generate  message digest keys used in symmetric
	key cryptography and, if the OpenSSL software library has been installed,
	it can generate host keys, sign keys, certificates and identity keys used
	by the Autokey public key cryptography. The message digest keys file is generated
	in a format compatible with NTPv3. All other files are in PEM-encoded printable
	ASCII format so they can be embedded as MIME attachments in mail to other
	sites.</p>

<p>When used to generate message digest keys, the program produces a file containing
	ten pseudo-random printable ASCII strings suitable for the MD5 message digest
	algorithm included in the distribution. If the OpenSSL library is installed,
	it produces an additional ten hex-encoded random bit strings suitable for
	the SHA1 and other message digest algorithms. Printable ASCII keys can have
	length from one to 20 characters, inclusive. Bit string keys have length
	20 octets (40 hex characters). All keys are 160 bits in length.</p>
<p> The file can be edited later with
	purpose-chosen passwords for the <tt>ntpq</tt> and <tt>ntpdc</tt> programs.
	Each line of the file contains three fields, first an integer between 1 and
	65534, inclusive, representing the key identifier used in the <tt>server</tt> and <tt>peer</tt> configuration
	commands. Next is the key type for the message digest algorithm,
	which in the absence of the OpenSSL library should be the string <tt>MD5</tt> to
	designate the  MD5 message digest algorithm.
	If the OpenSSL library is installed, the key type can be any message digest
	algorithm supported by that library. However, if compatibility with FIPS
	140-2 is required, the key type must be either <tt>SHA</tt> or <tt>SHA1</tt>.Finally
	is the key itself as a printable ASCII string excluding the space and # characters.
	If not greater than 20 characters in length, the string is the key itself;
	otherwise, it is interpreted as a hex-encoded bit string. As is
	custom, # and the remaining characters on the line are ignored. Later, this
	file can be edited to include the passwords for the <tt>ntpq</tt> and <tt>ntpdc</tt> utilities.
	If this is the only need, run <tt>ntp-keygen</tt> with the <tt>-M</tt> option
	and disregard the remainder of this page. </p>
<p>The remaining generated files are compatible with other OpenSSL applications and other Public Key Infrastructure (PKI) resources. Certificates generated by this program should be compatible with extant industry practice, although some users might find the interpretation of X509v3 extension fields somewhat liberal. However, the identity keys are probably not compatible with anything other than Autokey.</p>

<p>Most files used by this program are encrypted using a private password. The <tt>-p</tt> option specifies the password for local files and the <tt>-q</tt> option the password for files sent to remote sites. If no local password is specified, the host name returned by the Unix <tt>gethostname()</tt> function, normally the DNS name of the host, is used. If no remote password is specified, the local password is used.</p>

<p>The <tt>pw</tt> option of the <tt>crypto</tt> configuration command specifies the read password for previously encrypted files. This must match the local password used by this program. If not specified, the host name is used. Thus, if files are generated by this program without password, they can be read back by <tt>ntpd</tt> without password, but only on the same host.</p>

<p>All files and links are usually installed   in the  directory <tt>/usr/local/etc</tt>,
	which is normally in a shared filesystem in NFS-mounted networks and cannot
	be changed by shared clients. The location of the keys directory can be changed
	by the <tt>keysdir</tt> configuration command in such cases. Normally, encrypted
	files for each host are generated by that host and used only by that host,
	although exceptions exist as noted later on this page.</p>

<p>This program directs commentary and error messages to the standard error stream <tt>stderr</tt> and remote files to the standard output stream <tt>stdout</tt> where they can be piped to other applications or redirected to a file. The names used for generated files and links all begin with the string <tt>ntpkey</tt> and include the file type, generating host and filestamp, as described in the <a href="#fmt">Cryptographic Data Files</a> section below</p>

<h4 id="run">Running the Program</h4>

<p>To test and gain experience with Autokey concepts, log in as root and change to the keys directory, usually <tt>/usr/local/etc</tt>. When run for the first time, or if all files with names beginning <tt>ntpkey</tt> have been removed, use the <tt>ntp-keygen </tt>command without arguments to generate a default RSA host key and matching RSA-MD5 certificate with expiration date one year hence. If run again, the program uses the existing keys and parameters and generates only a new certificate with new expiration date one year hence; however, the certificate is not generated if the <tt>-e</tt> or <tt>-q</tt> options are  present.</p>

<p>Run the command on as many hosts as necessary. Designate one of them as the trusted host (TH) using <tt>ntp-keygen</tt> with the <tt>-T</tt> option and configure it to synchronize from reliable Internet servers. Then configure the other hosts to synchronize to the TH directly or indirectly. A certificate trail is created when Autokey asks the immediately ascendant host towards the TH to sign its certificate, which is then provided to the immediately descendant host on request. All group hosts should have acyclic certificate trails ending on the TH.</p>

<p>The host key is used to encrypt the cookie when required and so must be RSA type. By default, the host key is also the sign key used to encrypt signatures. A different sign key can be assigned using the <tt>-S</tt> option and this can be either RSA or DSA type. By default, the signature message digest type is MD5, but any combination of sign key type and sign digest type supported by the OpenSSL library can be specified using the <tt>-c</tt> option. At the moment, legacy considerations require the NTP packet header digest type to be MD5.</p>

<h4 id="trust">Trusted Hosts and Secure Groups</h4>

<p>As described on the <a href="authopt.html">Authentication Options</a> page, an NTP secure group consists of one or more low-stratum THs as the root from which all other group hosts derive synchronization directly or indirectly. For authentication purposes all hosts in a group must have the same group name specified by the <tt>-i</tt> option and matching the <tt>ident</tt> option of the <tt>crypto</tt> configuration command. The group name is used in the subject and issuer fields of trusted, self-signed certificates and when constructing the file names for identity keys. All hosts must have different host names, either the default host name or as specified by the <tt>-s</tt> option and matching the <tt>host</tt> option of the <tt>crypto</tt> configuration command. Most installations need not specify the <tt>-i</tt> option nor the <tt>host</tt> option. Host names are used in the subject and issuer fields of self-signed, nontrusted certificates and when constructing the file names for host and sign keys and certificates. Host and group names are used only for authentication purposes and have nothing to do with DNS names.</p>

<h4 id="ident">Identity Schemes</h4>

<p>As described on the <a href="authopt.html">Authentication Options</a> page, there are five identity schemes, three of which - IFF, GQ and MV - require identity keys specific to each scheme. There are two types of files for each scheme, an encrypted keys file and a nonencrypted parameters file, which usually contains a subset of the keys file. In general, NTP secondary servers operating as certificate signing authorities (CSA) use the keys file and clients use the parameters file. Both files are generated by the TA operating as a certificate authority (CA) on behalf of all servers and clients in the group.</p>

<p>The parameters files are public; they can be stored in a public place and
	sent in the clear. The keys files are encrypted with the local password. To
	retrieve the keys file, a host can send a mail request to the TA including its
	local password. The TA encrypts the keys file with this password and returns
	it as an attachment. The attachment is then copied intact to the keys directory
	with name given in the first line of the file, but all in lower case and with
	the filestamp deleted. Alternatively, the parameters file can be retrieved from
	a secure web site.</p>

<p>For example, the TA generates default host key, IFF keys and trusted certificate using the command</p>

<p><tt>ntp-keygen -p <i>local_passwd</i> -T -I -i<i>group_name</i></tt></p>

<p>Each group host generates default host keys and nontrusted certificate use
	the same command line but omitting the <tt>-i</tt> option. Once these media
	have been generated, the TA can then generate the public parameters using the
	command</p>

<p><tt>ntp-keygen -p local_passwd -e &gt;<i>parameters_file</i></tt></p>

<p>where the <tt>-e</tt> option redirects the unencrypted parameters to the standard output stream for a mail application or stored locally for later distribution. In a similar fashion the <tt>-q</tt> option redirects the encrypted server keys to the standard output stream.</p>

<h4 id="cmd">Command Line Options</h4>

<dl>

<dt><tt>-c [ RSA-MD2 | RSA-MD5 | RSA-SHA | RSA-SHA1 | RSA-MDC2 | RSA-RIPEMD160 | DSA-SHA | DSA-SHA1 ]</tt></dt>
<dd>Select certificate and message digest/signature encryption scheme. Note that
	RSA schemes must be used with a RSA sign key and DSA schemes must be used
	with a DSA sign key. The default without this option is <tt>RSA-MD5</tt>. If
	compatibility with FIPS 140-2 is required, either the <tt>DSA-SHA</tt> or <tt>DSA-SHA1</tt> scheme
	must be used.</dd>

<dt><tt>-d</tt></dt>
<dd>Enable debugging. This option displays the cryptographic data produced for eye-friendly billboards.</dd>

<dt><tt>-e</tt></dt>
<dd>Extract the IFF or GQ public parameters from the <tt>IFFkey</tt> or <tt>GQkey</tt> keys file previously specified. Send the unencrypted data to the standard output stream <tt>stdout</tt>. While the IFF parameters do not reveal the private group key, &nbsp;the GQ parameters  should be used with caution, as they include the group key. Use the <tt>-q</tt> option with password instead. Note: a new certificate is not generated when this option is present. This allows multiple commands with this option but  without disturbing existing media.</dd>

<dt><tt>-G</tt></dt>
<dd>Generate a new encrypted GQ key file   and link for the Guillou-Quisquater
	(GQ) identity scheme.</dd>

<dt><tt>-H</tt></dt>
<dd>Generate a new encrypted RSA public/private host key file and link<tt></tt>.
	Note that if the sign key is the same as the host key, generating a new host
	key invalidates all certificates signed with the old host key.</dd>

<dt><tt>-i <i>group</i></tt></dt>
<dd>Set the group name to <tt><i>group</i></tt>. This is used in the identity file names. It must match the group name specified in the <tt>ident</tt> option of the <tt>crypto</tt> configuration command.</dd>

<dt><tt>-I</tt></dt>
<dd>Generate a new encrypted IFF key file<tt> </tt>and link<tt> </tt>for the Schnorr (IFF) identity scheme.</dd>

<dt><tt>-m <i>modulus</i></tt></dt>
<dd>Set the modulus for generating files to <i>modulus</i> bits. The modulus defaults to 512, but can be set from 256 (32 octets) to 2048 (256 octets).</dd>

<dt><tt>-M</tt></dt>
<dd>Generate a new MD5 key file containing 16, 128-bit pseudo-random keys for
	symmetric cryptography..</dd>

<dt><tt>-P</tt></dt>
<dd>Generate a new private certificate used by the PC identity scheme. By default, the program generates public certificates. Note: the PC identity scheme is not recommended for new installations.</dd>

<dt><tt>-p <i>passwd</i></tt></dt>
<dd>Set the password for reading and writing encrypted files to <tt><i>passwd</i></tt>. By default, the password is the host name.</dd>

<dt><tt>-q <i>passwd</i></tt></dt>
<dd>Extract the encrypted IFF or GQ server keys from the <tt>IFFkey</tt> or <tt>GQkey</tt> key file previously generated. The data are sent to the standard output stream <tt>stdout</tt>. Set the password for writing the data, which is also the password to read the data file in another host. By default, the password is the host name. Note: a new certificate is not generated when this option is present. This allows multiple commands with this option but without disturbing existing media.</dd>

<dt><tt>-S [ RSA | DSA ]</tt></dt>
<dd>Generate a new sign key of the specified type. By default, the sign key is
	the host key and has the same type. If compatibly with FIPS 140-2 is required,
	the sign key type must be <tt>DSA</tt>. Note that generating a new sign key
	invalidates all certificates signed with the old sign key.</dd>

<dt><tt>-s <i>host</i></tt></dt>
<dd>Set the host name to <tt><i>host</i></tt>. This is used in the host and sign key file names. It must match the host name specified in the <tt>host</tt> option of the <tt>crypto</tt> configuration command.</dd>

<dt><tt>-T</tt></dt>
<dd>Generate a trusted certificate. By default, the program generates nontrusted certificates.</dd>

<dt><tt>-V <i>nkeys</i></tt></dt>
<dd>Generate server parameters <tt>MV</tt> and <tt><i>nkeys</i></tt> client keys for the Mu-Varadharajan (MV)  identity scheme. Note: support for this option should be considered a work in progress.</dd>
</dl>

<h4 id="rand">Random Seed File</h4>

<p>All cryptographically sound key generation schemes must have means to randomize the entropy seed used to initialize the internal pseudo-random number generator used by the OpenSSL library routines. If a site supports <tt>ssh</tt>, it is very likely that means to do this are already available. The entropy seed used by the OpenSSL library is contained in a file, usually called <tt>.rnd</tt>, which must be available when starting the <tt>ntp-keygen</tt> program or <tt>ntpd</tt> daemon.</p>

<p>The OpenSSL library looks for the file using the path specified by the <tt>RANDFILE</tt> environment variable in the user home directory, whether root or some other user. If the <tt>RANDFILE</tt> environment variable is not present, the library looks for the <tt>.rnd</tt> file in the user home directory. Since both the <tt>ntp-keygen</tt> program and <tt>ntpd</tt> daemon must run as root, the logical place to put this file is in <tt>/.rnd</tt> or <tt>/root/.rnd</tt>. If the file is not available or cannot be written, the program exits with a message to the system log.</p>
<p>On systems that provide /dev/urandom, the randomness device is used instead and the file specified by the <tt>randfile</tt> subcommand or the <tt>RANDFILE</tt> environment variable is ignored.</p>

<h4 id="priv">Cryptographic Data Files</h4>

<p>File and link names are in the form <tt>ntpkey_<i>key</i>_<i>name</i>.<i>fstamp</i></tt>, where <tt><i>key</i></tt> is the key or parameter type, <tt><i>name</i></tt> is the host or group name and <tt><i>fstamp</i></tt> is the filestamp (NTP seconds) when the file was created). By convention, key fields in generated file names include both upper and lower case alphanumeric characters, while key fields in generated link names include only lower case characters. The filestamp is not used in generated link names.</p>

<p>The key type is a string defining the cryptographic function. Key types include public/private keys <tt>host</tt> and <tt>sign</tt>, certificate <tt>cert</tt> and several challenge/response key types. By convention, files used for challenges have a <tt>par</tt> subtype, as in the IFF challenge <tt>IFFpar</tt>, while files for responses have a <tt>key</tt> subtype, as in the GQ response <tt>GQkey</tt>.</p>

<p>All files begin with two nonencrypted lines. The first line contains the file name in the format <tt>ntpkey_<i>key</i>_<i>host</i>.<i>fstamp</i></tt>. The second line contains the datestamp in conventional Unix <tt>date</tt> format. Lines beginning with <tt>#</tt> are ignored.</p>

<p>The remainder of the file contains cryptographic data encoded first using ASN.1 rules, then encrypted using the DES-CBC algorithm and given password and finally written in PEM-encoded printable ASCII text preceded and followed by MIME content identifier lines.</p>

<p id="symkey">The format of the symmetric keys file is somewhat different than the other files in the interest of backward compatibility. Since DES-CBC is deprecated in NTPv4, the only key format of interest is MD5 alphanumeric strings. Following the header the keys are entered one per line in the format</p>

<p><i><tt>keyno type key</tt></i></p>

<p>where <i><tt>keyno</tt></i> is a positive integer in the range 1-65,535, <i><tt>type</tt></i> is the string <tt>MD5</tt> defining the key format and <i><tt>key</tt></i> is the key itself, which is a printable ASCII string 16 characters or less in length. Each character is chosen from the 93 printable characters in the range 0x21 through 0x7f excluding space and the '#' character.</p>

<p>Note that the keys used by the <tt>ntpq</tt> and <tt>ntpdc</tt> programs are checked against passwords requested by the programs and entered by hand, so it is generally appropriate to specify these keys in human readable ASCII format.</p>

<p>The <tt>ntp-keygen</tt> program generates a MD5 symmetric keys file <tt>ntpkey_MD5key_<i>hostname.filestamp</i></tt>. Since the file contains private shared keys, it should be visible only to root and distributed by secure means to other subnet hosts. The NTP daemon loads the file <tt>ntp.keys</tt>, so <tt>ntp-keygen</tt> installs a soft link from this name to the generated file. Subsequently, similar soft links must be installed by manual or automated means on the other subnet hosts. While this file is not used with the Autokey Version 2 protocol, it is needed to authenticate some remote configuration commands used by the <a href="ntpq.html"><tt>ntpq</tt></a> and <a href="ntpdc.html"><tt>ntpdc</tt></a> utilities.</p>

<h4 id="bug">Bugs</h4>

<p>It can take quite a while to generate some cryptographic values, from one to several minutes with modern architectures such as UltraSPARC and up to tens of minutes to an hour with older architectures such as SPARC IPC.</p>

<hr>

<script type="text/javascript" language="javascript" src="scripts/footer.txt"></script>

</body>

</html>