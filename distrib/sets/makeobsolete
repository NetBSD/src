#!/bin/sh
#
# $NetBSD: makeobsolete,v 1.18 2003/09/21 19:26:05 tron Exp $
#
# Print out the obsolete files for a set
# Usage: makeobsolete [-b] [-x] [-a arch] [-m machine] [-s setsdir] \
#    [-t target] [setname ...]
#

# set defaults
make="${MAKE:-make} -j 1 -f `dirname $0`/Makefile"
machine=`${make} print_machine`
arch=`${make} print_machine_arch`
setd=`pwd`
nlists="base comp etc games man misc text"
xlists="xbase xcomp xcontrib xfont xserver xmisc"
lists=$nlists
target=./dist
have_gcc3="`${make} print_have_gcc3`"

# handle args
while : ; do
	case $1 in
	-b*)
		lists="$xlists $nlists"
		;;
	-x*)
		lists=$xlists;;
	-a*)
		arch=$2; shift
		;;
	-m*)
		machine=$2; shift
		;;
	-s*)
		setd=$2; shift
		;;
	-t*)
		target=$2;shift
		;;
	-*)
		cat 1>&2 <<USAGE
Usage: $0 [-a arch] [-m machine] [-s setsdir] [setname ...]
	-b		make netbsd + x11 lists
	-x 		only make x11 lists
	-a arch		set arch (e.g, m68k, mips, powerpc)	[$arch]
	-m machine	set machine (e.g, amiga, i386, macppc)	[$machine]
	-s setsdir	directory to find sets	[$setd]
	-t target	target directory [$target]
	[setname ...] 	sets to build
USAGE
		exit 1
		;;
	*)
		break
		;;
	esac
	shift
done
if [ -n "$1" ]; then
	lists="$*"
fi

# Convert mipse[lb] to mips after processing command line arguments.
arch=`echo $arch | sed s,^mipse.,mips, | sed s,^sh3e.,sh3e,`

if [ ! -d $target ] ; then
	echo "target directory [$target] doesn't exist"
	exit 1
fi

# Automatically add XFree86 version specific sets
for list in $lists
do
 if [ -z "$_lists" ]
 then
  _lists=$list
 else
  _lists="$_lists $list"
 fi
 if [ -d "$setd/lists/$list${x11_version}" ]
 then
  _lists="$_lists $list${x11_version}"
 fi
done
lists=$_lists
unset _lists

for setname in $lists; do
	file=$target/${setname}
	(
	if [ -f $setd/lists/$setname/obsolete.mi ]; then
		awk -- '{print $1}' $setd/lists/$setname/obsolete.mi
	fi
	if [ "$machine" != "$cpu" -a \
	    -f $setd/lists/$setname/obsolete.${arch} ]; then
		awk -- '{print $1}' $setd/lists/$setname/obsolete.${arch}
	fi
	if [ -f $setd/lists/$setname/obsolete.${machine} ]; then
		awk -- '{print $1}' $setd/lists/$setname/obsolete.${machine}
	fi
	if [ "$have_gcc3" = yes -a -f $setd/lists/$setname/obsolete.gcc ]; then
		awk -- '{print $1}' $setd/lists/$setname/obsolete.gcc
	fi
	) | egrep -v '^#' | sort -ru > $file
	if [ ! -s $file ] ; then
		rm $file
	fi

done
