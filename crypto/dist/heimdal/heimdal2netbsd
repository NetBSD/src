#! /bin/sh

# $Heimdal: heimdal2netbsd,v 1.3 2002/09/12 14:12:18 joda Exp $
# $NetBSD: heimdal2netbsd,v 1.4 2003/01/26 20:51:58 elric Exp $

if [ \! -f kuser/kinit.c ]; then 
	echo "`basename $0`: should be run in top src directory" 1>&2
	exit 1
fi

if ! type perl > /dev/null 2>&1 ; then
	echo "`basename $0`: you need perl to run this" 1>&2
	exit 1
fi


echo 'Removing preformatted man pages.'
find . -name '*.cat[1358]' | xargs rm -f
rm doc/heimdal.info

echo 'Fixing .Os in man pages.'
perl -i~ -p -e 's/\.Os HEIMDAL/.Os/' `find . -name '*.[1358]'`

echo 'Changing $Id: heimdal2netbsd,v 1.4 2003/01/26 20:51:58 elric Exp $ to $Heimdal$.'
## Ugh!
set -- 'RCSID\("'	'"\)'	'__RCSID("'	'"\n        "\$NetBSD\$")' \
	'/\* '		' \*/'	'/* '		'\n   \$NetBSD\$ */'       \
	'# '		''	'# '		'\n# \$NetBSD\$'           \
	'\.\\" '	''	'.\\" '		'\n.\\" \$NetBSD\$'        \
	'dnl '		''	'dnl '		'\ndnl \$NetBSD\$'


e=
while [ $# -gt 0 ]; do
	e="${e}s,$1\\\$Id([^\\\$]*)\\\$$2,$3\\\$Heimdal\\1\\\$$4,;"
	shift 4
done

perl -i~ -p -e "$e" `find . -type f`

echo 'Inlining <krb5-types.h> in krb5.h and gssapi.h.'
perl -i~ -p -e 's,#include <krb5-types.h>,#include <sys/types.h>\n#include <inttypes.h>\n#include <sys/socket.h>\ntypedef socklen_t krb5_socklen_t;\ntypedef ssize_t krb5_ssize_t;,' lib/gssapi/gssapi.h lib/krb5/krb5.h

echo 'Fixing up include paths:'

update_inc() {
	echo " fixing $1 leaving old file in $1~"
	mv $1 $1~
	< $1~ > $1 \
	sed -e 's,#include <asn1_err.h>,#include <krb5/asn1_err.h>,'	      \
	    -e 's,#include <krb5_err.h>,#include <krb5/krb5_err.h>,'	      \
	    -e 's,#include <heim_err.h>,#include <krb5/heim_err.h>,'	      \
	    -e 's,#include <k524_err.h>,#include <krb5/k524_err.h>,'	      \
	    -e 's,#include <krb5_asn1.h>,#include <krb5/krb5_asn1.h>,'	      \
	    -e 's,#include <hdb_asn1.h>,#include <krb5/hdb_asn1.h>,'	      \
	    -e 's,#include <hdb_err.h>,#include <krb5/hdb_err.h>,'	      \
	    -e 's,#include <hdb-protos.h>,#include <krb5/hdb-protos.h>,'      \
	    -e 's,#include <roken-common.h>,#include <krb5/roken-common.h>,'  \
	    -e 's,#include <sl.h>,#include <krb5/sl.h>,'
}

update_inc lib/krb5/krb5.h
update_inc lib/hdb/hdb.h
update_inc lib/roken/roken.h.in
update_inc lib/sl/ss.h

echo 'Remember to update files in basesrc/include/heimdal/.'

exit 0
