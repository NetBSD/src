# $NetBSD: CHANGES-9.4,v 1.1.2.40 2023/01/18 19:29:16 martin Exp $

A complete list of changes from the NetBSD 9.3 release to the NetBSD 9.4
release:

external/gpl2/groff/tmac/mdoc.local		patched by hand
sys/sys/param.h 				patched by hand
doc/README.files				patched by hand
doc/CHANGES-9.4					added

	Welcome to 9.3_STABLE.
	[martin]

sys/netinet6/nd6.c				(apply patch)

	PR 55680: avoid duplicate free of link layer entries.
	[kim, ticket #1497]

lib/libpthread/pthread.c			1.181 (via patch)

	Fix pthread hangs on startup.
	[riastradh, #1498]

sys/dev/ic/dwc_gmac.c				1.76,1.77

	Fix chip configuration so that stripping of the FCS is
	consistent for all packet types.
	[sekiya, ticket #1499]

sys/dev/raidframe/rf_disks.c			1.93 (patch)
sys/dev/raidframe/rf_driver.c			1.140(patch)
sys/dev/raidframe/rf_netbsdkintf.c		1.408(patch)

	raid(4): reject invalid values for numCol and numSpares.
	Explicitly nul-terminate all strings coming from userland.
	Avoids signed arithmetic in some ioctl commands.
	[mrg, ticket #1500]

sys/kern/uipc_sem.c				1.60

	PR 55509: fix per-uid "semcnt" bookeeping.
	[chs, ticket #1501]

libexec/telnetd/utility.c			1.34

	telnetd(8): fix CVE-2020-10188.
	[hgutch, ticket #1502]

external/cddl/osnet/dist/lib/libzfs/common/libzfs_import.c 1.6,1.7

	Enable zpool(8) to reliably find components on dk(4) wedges.
	[riastradh, ticket #1503]

sys/fs/ptyfs/ptyfs_vnops.c			1.69

	ptyfs: fix buffer overrun.
	[riastradh, ticket #1504]

sys/dev/ic/tpm.c				1.20
sys/dev/isa/tpm_isa.c				1.8

	tpm(4): kernel attach messages cosmetics.
	[riastradh, ticket #1505]

sys/dev/raidframe/rf_netbsdkintf.c		1.409

	raid(4): reject the RAIDFRAME_SET_LAST_UNIT and RAIDFRAME_SHUTDOWN
	ioctls when RAIDframe is not initialized.
	[oster, ticket #1506]

bin/test/test.c					1.45

	PR 56983: fix confusing message in test(1).
	[dholland, ticket #1507]

libexec/telnetd/telnetd.c			1.58 (patch)

	telnetd(8): fix a crash accessing the slc table before initialization.
	[dholland, ticket #1508]

sys/dev/scsipi/sd.c				1.335
sys/dev/scsipi/sdvar.h				1.40

	sd(4): fix buffer over-read leading to garbage appended
	to the device type string and possible information disclosure.
	[mlelstv, ticket #1509]


external/mit/xorg/bin/xdm/Makefile		1.18,1.19
external/mit/xorg/bin/xdm/Makefile.xdm		1.11

	PR 54851: xdm(8): fix the man page generation, and include
	"sbin" directories (and games) in DEF_USER_PATH.
	[nia, ticket #1510]

external/mit/xorg/server/drivers/xf86-video-wsfb/Makefile 1.6

	wsfb(4): disable broken DGA extension for xf86-video-wsfb.
	[rin, ticket #1511]

sys/dev/ata/ata.c				1.163

	wd(4): fix verbose attach messages for ATA controllers w/o UltraDMA
	support.
	[tsutsui, ticket #1512]

sys/arch/m68k/m68k/m68k_trap.c			1.3

	m68k: make a DEBUG kernel compilable.
	[tsutsui, ticket #1513]

distrib/amiga/floppies/inst-common/dot.commonutils 1.9
distrib/amiga/miniroot/dot.profile		1.11
distrib/atari/floppies/common/dot.profile	1.9
distrib/utils/script-installer/dot.commonutils	1.8
distrib/vax/inst-common/dot.commonutils		1.6

	PRs 54835, 54835, 56983: adapt install scripts to the shell
	being compiled without support for depracated test expressions.
	[tsutsui, ticket #1514]

sys/dev/pci/if_wm.c				1.741-1.749,1.753-1.757,
						1.762 via patch
sys/dev/pci/if_wmreg.h				1.126-1.127

	- Fix I219 workaround in wm_flush_desc_rings().
	- Add more statistics counters.
	- To avoid releasing mutex temporally, use new
	  wm_set_mdio_slow_mode_hv_locked().
	- No functional changes:
	  - Turn a locking botch (shouldn't drop lock on error) into a KASSERT
	    in wm_deferred_start_locked().
	  - Remove unneeded header inclusion.
	  - Use __BIT() a little.
	  - Modify comment and debug messages.
	  - Consistency use -1 instead of 1 for some error code.
	  - KNF.
	[msaitoh, ticket #1515]

sys/kern/kern_core.c				1.36

	Fix kauth credential reference leak.
	[christos, ticket #1516]

sys/kern/kern_core.c				1.37

	Avoid a GCC warning.
	[mrg, ticket #1517]

sys/arch/atari/dev/ite.c			1.82
sys/arch/atari/dev/ite_cc.c			1.45
sys/arch/atari/dev/ite_et.c			1.36
sys/arch/atari/dev/itevar.h			1.15

	Add a minimum DEC special graphics character support
	for atari ite(4).
	[tsutsui, ticket #1518]

sys/arch/atari/atari/atari_init.c		1.105
sys/arch/atari/conf/GENERIC.in			1.123
sys/arch/atari/conf/files.atari			1.124
sys/arch/atari/conf/ATARITT			(regen)
sys/arch/atari/conf/FALCON			(regen)
sys/arch/atari/conf/HADES			(regen)
sys/arch/atari/conf/MILAN-ISAIDE		(regen)
sys/arch/atari/conf/MILAN-PCIIDE		(regen)
sys/arch/atari/conf/SMALL030			(regen)

	Improve the Atari ST-RAM reservation to make the old Xserver
	work by default.
	[tsutsui, ticket #1519]

sys/arch/atari/vme/if_le_vme.c			1.32,1.33

	le(4): fix a long-standing "leprobe: cannot map memory-area"
	error during probe.
	[tsutsui, ticket #1520]

sys/arch/atari/conf/MILAN.in			1.30
sys/arch/atari/pci/pci_vga.c			1.19
sys/arch/atari/conf/ATARITT			(regen)
sys/arch/atari/conf/FALCON			(regen)
sys/arch/atari/conf/HADES			(regen)
sys/arch/atari/conf/MILAN-ISAIDE		(regen)
sys/arch/atari/conf/MILAN-PCIIDE		(regen)
sys/arch/atari/conf/SMALL030			(regen)

	Improve VGA console settings for Milan, especially for sysinst.
	[tsutsui, ticket #1521]

usr.bin/netstat/atalk.c		1.18,1.20-1.21
usr.bin/netstat/bpf.c		1.16 via patch
usr.bin/netstat/fast_ipsec.c	1.24
usr.bin/netstat/if.c		1.97-1.99,1.101-1.104 via patch
usr.bin/netstat/inet.c		1.111,1.115-1.116 via patch
usr.bin/netstat/inet6.c		1.74-1.75,1.80-1.81 via patch
usr.bin/netstat/main.c		1.100-1.103
usr.bin/netstat/mbuf.c		1.35
usr.bin/netstat/mroute.c	1.26-1.27
usr.bin/netstat/mroute6.c	1.16
usr.bin/netstat/netstat.h	1.52-1.53
usr.bin/netstat/pfkey.c		1.4-1.5 via patch
usr.bin/netstat/pfsync.c	1.4-1.5 via patch
usr.bin/netstat/route.c		1.86-1.88
usr.bin/netstat/unix.c		1.36-1.37
usr.bin/netstat/vtw.c		1.11,1.13

	- sprintf() -> snprintf(), and adjust a buffer size to avoid any
	  potential for overflow.
	- Fix netstat -rs to print it correctly.
	- Add missing {IP,IP6}_STAT_NOIPSEC to netstat.
	- Don't show any of the completely and utterly undocumented VTW info
	  if the feature isn't enabled.
	- Print oqdrops correctly.
	- Remove Network ATM soft intr queue reporting, we don't have that
	  in the kernel anymore.
	- netstat.1: Add various xrefs present in the body to "See Also".
	- KNF. Style fixes.
	[msaitoh, ticket #1522]

usr.bin/ftp/Makefile                            up to 1.39
usr.bin/ftp/fetch.c                             up to 1.235
usr.bin/ftp/ftp.1                               up to 1.147
usr.bin/ftp/ftp_var.h                           up to 1.86
usr.bin/ftp/main.c                              up to 1.128
usr.bin/ftp/ssl.c                               up to 1.12
usr.bin/ftp/util.c                              up to 1.164
usr.bin/ftp/version.h                           up to 1.94

	ftp(1): PR 57003: Support relative redirects.
	[christos, #1523]

sys/dev/ic/mfireg.h				1.22
sys/dev/pci/mfii.c				1.16-1.22,1.27 via patch
share/man/man4/mfii.4				1.3 via patch

	- Fix wrong access in mfii_start().
	- Add SAS3216,SAS3224,SAS3316 and SAS3324 support.
	- Add CVPM02 BBU support.
	- Use bus_space_write_8() if available.
	- Don't panic on detach if no any sensor device.
	- Add comment. Sort entries. KNF.
	[msaitoh, #1524]

sys/dev/usb/xhci.c				1.154

	Accept USB 3.2 in xhci_id_protocols().
	[msaitoh, ticket #1525]

sys/arch/x86/x86/procfs_machdep.c		1.45

	procfs: on x86 add tdx_guest, brs, hfi, ibt, amx_bf16, amx_tile
	and amx_int8.
	[msaitoh, ticket #1526]

libexec/ld.elf_so/arch/powerpc/ppc_reloc.c	1.62

	Fix copy & pasto: DTPREL relocations do not need to allocate a static
	TLS index.
	[martin, ticket #1531]

sys/external/bsd/acpica/dist/dispatcher/dswexec.c 1.2

	Fix out of range access in AcpiDsExecEndOp().
	[msaitoh, ticket #1527]

sys/dev/usb/if_ure.c				1.58 (via patch)

	ure(4): use unsigned to avoid undefined behavior in ure_uno_mcast().
	[msaitoh, ticket #1528]

sys/dev/usb/usb.h				1.121

	Cast to uint32_t to avoid undefined behavior in UGETDW().
	[msaitoh, ticket #1529]

sys/crypto/nist_hash_drbg/nist_hash_drbg.c	1.2,1.3

	Fix negative-length variable-length array.
	[msaitoh, ticket #1530]

external/cddl/osnet/dist/uts/common/fs/zfs/zfs_vnops.c	(apply patch)

	Fix mounting of wapbl volumes when the block device node is on
	a zfs volume. Fixed differently as part of a bigger change in
	-current in rev 1.73.
	[dholland, ticket #1532]

sys/arch/arm/sunxi/sunxi_can.c			1.10,1.11

	Improve sunxican(4) RX interrupt handling to reduce the risk of
	receive overrun, and improve receive overrun recovery.
	[bouyer, ticket #1533]

sys/dev/pci/mfii.c				1.28

	mfii(4): Convert from pci_intr_map() to pci_intr_alloc(); makes
	the driver use MSI/MSI-x when available.
	[bouyer, ticket #1534]

usr.sbin/sysinst/arch/landisk/md.c		1.16

	PR install/57025: revert bogus rev 1.9 which was only papering over
	a bug in the adoption of the MBR handling code and fix the original
	conversion bug instead:
	 - run fdisk to install the MBR bootcode on the raw disk partition
	 - run installboot against the NetBSD root partition (not the raw
	   partition).
	[martin, ticket #1535]

sys/arch/x86/include/i82093reg.h		1.7
sys/arch/x86/x86/ioapic.c			1.66

	- Fix a bug that an IOAPIC ID is tried to remap with a wrong ID.
	  The bit width is 8 bits these days. Fixes PR kern/54276.
	- Print detail about misconfigured APIC ID.
	[msaitoh, ticket #1536]

sys/arch/x86/pci/imcsmb/imc.c			1.5
sys/dev/pci/pcidevs				1.1461-1.1468
sys/dev/pci/pcidevs.h				(regen)
sys/dev/pci/pcidevs_data.h			(regen)

	- Add several samsung nvme entries.
	- Add more Alder Lake devices.
	- Jasper Lake Intel Trace Hub on Compute Die is not 0x4da6 but 0x4e29.
	- Add Intel Core 8G (8core, H, Halo) Host Bridge, DRAM.
	- Add AMD 19h/6xh Root Complex. 
	- Add AMD FCH SATA Controller D.
	- Add NVIDIA GeForce GTX 770.
	- Sort by number.
	[msaitoh, ticket #1537]

sys/arch/x86/include/cpu_ucode.h		1.5
sys/arch/x86/x86/cpu_ucode_intel.c		1.19,1.20

	- Verify checksum of the extended signature table.
	- KNF.
	[msaitoh, ticket #1538]

share/man/man4/man4.x86/amdsmn.4		1.5
sys/arch/x86/pci/amdsmn.c			1.14
sys/arch/x86/pci/amdzentemp.c			1.12-1.15

	amdsmn(4), amdzentemp(4): Add zen3 and zen4 support.
	Add support for per CCD temperature sensor.
	[msaitoh, ticket #1539]

usr.bin/skey/skeyaudit.sh			1.5

	Adapt to removal of "Mail".
	[is, ticket #1540]

share/man/man4/lm.4				1.37
sys/dev/ic/nslm7x.c				1.78
sys/dev/isa/wbsio.c				1.28
sys/dev/isa/wbsioreg.h				1.10

	Add Nuvoton NCT6799D support.
	[msaitoh, ticket #1541]

sys/arch/x86/include/specialreg.h		1.189-1.192
sys/dev/nvmm/x86/nvmm_x86.c			1.23
usr.sbin/cpuctl/arch/i386.c			1.128

	- Add top-down slots event bit of architectural performance monitoring
	  leaf.
	- Modify CPUID Fn0000000a %ebx's string. Add new string for %ecx.
	- Modify output of CPUID Fn0000000a.
	- Update some AMD CPUID bits.
	- Fix typo.
	[msaitoh, ticket #1542]

sys/dev/tprof/tprof_x86_intel.c 		1.4
usr.sbin/tprof/arch/tprof_x86.c 		1.10-1.12

	- Add topdown-slots to Intel architectural performance monitoring
	  version 1.
	- Disable the unsupported events based on CPUID Fn0000000a %eax.
	- Fix typo in comment. Remove duplicated macros.
	[msaitoh, ticket #1543]

sys/dev/pci/ichsmb.c				1.76-1.77 (via patch)

	Add Intel 600 Series PCH support.
	[msaitoh, ticket #1544]

external/public-domain/tz/dist/SECURITY         up to 1.1.1.1
external/public-domain/tz/dist/CONTRIBUTING     up to 1.1.1.7
external/public-domain/tz/dist/Makefile         up to 1.1.1.33
external/public-domain/tz/dist/NEWS             up to 1.1.1.38
external/public-domain/tz/dist/README           up to 1.1.1.10
external/public-domain/tz/dist/TZDATA_VERSION   up to 1.30
external/public-domain/tz/dist/africa           up to 1.1.1.28
external/public-domain/tz/dist/antarctica       up to 1.1.1.15
external/public-domain/tz/dist/asia             up to 1.5
external/public-domain/tz/dist/australasia      up to 1.5
external/public-domain/tz/dist/backward         up to 1.5
external/public-domain/tz/dist/backzone         up to 1.1.1.23
external/public-domain/tz/dist/calendars        up to 1.1.1.2
external/public-domain/tz/dist/checktab.awk     up to 1.1.1.11
external/public-domain/tz/dist/etcetera         up to 1.1.1.6
external/public-domain/tz/dist/europe           up to 1.1.1.34
external/public-domain/tz/dist/leap-seconds.list up to 1.4
external/public-domain/tz/dist/leapseconds      up to 1.4
external/public-domain/tz/dist/northamerica     up to 1.1.1.30
external/public-domain/tz/dist/southamerica     up to 1.1.1.20
external/public-domain/tz/dist/theory.html      up to 1.1.1.15
external/public-domain/tz/dist/version          up to 1.5
external/public-domain/tz/dist/ziguard.awk      up to 1.1.1.9
external/public-domain/tz/dist/zishrink.awk     up to 1.1.1.8
external/public-domain/tz/dist/zone.tab         up to 1.1.1.22
external/public-domain/tz/dist/zone1970.tab     up to 1.1.1.23
distrib/sets/lists/base/mi			(apply patch)
doc/3RDPARTY					(apply patch)

	Update timezone data to 2022e.
	[kre, ticket #1546]

usr.bin/progress/progress.c			1.24,1.25

	PR 56303: progress(1): fix error handling.
	[riastradh, ticket #1547]

sys/netinet6/frag6.c				1.76

	frag6: do not use a spin mutex for frag6_lock.
	[ozaki-r, ticket #1548]

bin/sh/miscbltin.c				1.51,1.52

	PR 56972: fix escape ('\') handling in sh read builtin
	and cosmetic improvements to error reporting.
	[kre, ticket #1549]

sys/dev/usb/uhidev.c				1.94

	PR 57031: back out rev 1.82 "Do not explicitly set the HID Report
	Protocol upon attach", pulled up for 9.3 in ticket #1428.
	[jmcneill, ticket #1550]

sys/arch/hp300/dev/topcat.c			1.6

	Fix silent bus error panic on 98543A topcat framebuffer on
	HP320 and HP360.
	[tsutsui, ticket #1551]

sys/arch/hp300/dev/rd.c				1.111-1.124
sys/arch/hp300/dev/rdreg.h			1.19,1.20
sys/arch/hp300/dev/rdvar.h			1.27
sys/arch/hp300/stand/common/rd.c		1.12-1.15

	- Fix bootloader to allow booting from 2202A, 7908A, 7911A, and 7941A.
	- Fix "rd(4) at punits not configured on HPDisk are misprobed" problem.
	- Make dd(1) without a count value against a raw partition etc.
	  is terminated properly at the end of media.
	- Make MI raid(4) work on HP-IB rd(4) disks.
	[tsutsui, ticket #1552]

usr.sbin/sysinst/bsddisklabel.c			1.67

	sysinst: avoid confusion when adding a /usr partition after
	manually sizing the / partition.
	[martin, ticket #1553]

usr.sbin/sysinst/arch/amiga/md.c		1.10
usr.sbin/sysinst/arch/atari/md.c		1.10
usr.sbin/sysinst/arch/dummy/md.c		1.8
usr.sbin/sysinst/arch/sparc/md.c		1.8
usr.sbin/sysinst/arch/sparc64/md.c		1.8

	sysinst: properly set default disk size unit on more
	architectures.
	[martin, ticket #1554]

sys/nfs/nfs_srvsocket.c				1.5

	NFS: avoid mbuf leaks and corruption.
	[hannken, ticket #1555]

usr.bin/calendar/calendars/calendar.christian	1.11

	calendar(8): update calendar.christian for 2023.
	[nia, ticket #1556]

sys/dev/ata/ata.c				1.155,1.164
sys/dev/ata/ata_recovery.c			1.4
sys/dev/ata/ata_wdc.c				1.115,1.120
sys/dev/ata/atavar.h				1.105,1.109
sys/dev/ata/satapmp_subr.c			1.16
sys/dev/ata/wd.c				1.460,1.462
sys/dev/ic/ahcisata_core.c			1.83,1.93,1.102
sys/dev/ic/mvsata.c				1.56,1.61
sys/dev/ic/siisata.c				1.42,1.49
sys/dev/ic/wdc.c				1.299,1.308
sys/dev/ic/wdcvar.h				1.100
sys/dev/scsipi/atapi_wdc.c			1.138
sys/dev/scsipi/atapi_wdc.c			1.141
sys/dev/usb/umass_isdata.c			(apply patch)

	PR 56403, 56973, 56982: fix locking issues in ATA layer,
	fix a use-after-free, fix silent stall on NOIRQ ports.
	[tsutsui, ticket #1557]

usr.sbin/sysinst/disklabel.c			1.46-1.48
usr.sbin/sysinst/label.c			1.40-1.41

	PR 56886: fix space accounting in sysinst after deleting partitions.
	[martin, ticket #1558]

usr.sbin/sysinst/arch/amiga/md.c		1.8
usr.sbin/sysinst/arch/amiga/md.c		1.9
usr.sbin/sysinst/arch/x68k/md.c			1.13
usr.sbin/sysinst/defs.h				1.85
usr.sbin/sysinst/disklabel.c			1.49

	PR 56890: check on-disk disklabel properly even on ports without
	raw BSD disklabel.
	[tsutsui, ticket #1559]

sys/conf/copyright				1.21

	Welcome to 2023.
	[gutteridge, ticket #1562]

sbin/fsck/partutil.c				1.18

	PR 57134: fix newfs(8) when used for devices without
	partition suffix (e.g. vnd0 instead of vnd0d or vnd0c).
	[hannken, ticket #1560]

lib/libc/locale/setlocale.3			1.22,1.23

	setlocale.3: Reflect state of NetBSD locale support in the 21st
	century.
	[nia, ticket #1561]

lib/libc/gen/err.3				1.23

	Add errc() and verrc() to the list of functions which do not return,
	but exit() instead.
	[kre, ticket #1563]

sys/arch/m68k/m68k/bus_dma.c			1.39

	PR 57107: fix out of bounds invalidate (and writeback) in
	bus_dmamap_sync(9) ops.
	[tsutsui, ticket #1564]

sys/arch/mac68k/conf/INSTALL			1.58

	Disable (comment out) options DIAGNOSTIC in INSTALL kernels.
	[tsutsui, ticket #1565]

sys/dev/pci/pcidevs				1.1469-1.1476
sys/dev/pci/sdhc_pci.c				1.20
sys/dev/pci/pcidevs.h				regen
sys/dev/pci/pcidevs_data.h			regen

	- Add some AMD 17h/9xh, 17h/Axh and 19h/1xh devices.
	- Add some Intel Xeon Scalable devices.
	- Update Intel Elkhart Lake devices.
	- Add Aquantia (Marvell) AQC113 Ethernet devices and the variants.
	- Fix typo. s/SSC/SCC/.
	[msaitoh, ticket #1566]

