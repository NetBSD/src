# $NetBSD: CHANGES-7.0,v 1.1.2.28 2014/08/30 19:34:04 martin Exp $

A complete list of changes from the initial NetBSD 7.0 branch on 11 Aug 2014
until the 7.0 release:

doc/CHANGES-7.0					patched by hand
doc/LAST_MINUTE					patched by hand
doc/README.files				patched by hand
gnu/usr.bin/groff/tmac/mdoc.local		patched by hand
sys/sys/param.h					patched by hand

	Welcome to 7.0_BETA!

sys/dev/usb/xhci.c				1.24

	PR/49091: xhci: wrong wMaxPacketSize value
	While this is correct according to the specification only fixed sizes
	are allowed, i.e. 512 for SS, etc. Maybe these should be used?
	[skrll, ticket #3]


sys/kern/kern_rndpool.c				1.7
sys/kern/kern_rndq.c				1.27

	buf is not guaranteed to be aligned; don't *(uint32_t *) it.
	done is not guaranteed to be aligned; don't *(uint32_t *) it.
	Fixes PR kern/49098.
	[riastradh, ticket #4]

external/gpl3/binutils/dist/bfd/ChangeLog	1.6
external/gpl3/binutils/dist/bfd/elflink.c	1.8

	Apply change from upstream to fix PR/48709 - port-alpha/48709: static
	threaded programs crash.
	With this fix the new weak symbol's st_other is not merged in, i.e. NOPV
	is not copied from the libc __libc_thr_init.
	* elflink.c (_bfd_elf_merge_symbol): If merging a new weak
	symbol that will be skipped, we don't have a new definition.
	[skrll, ticket #5]


sys/dev/usb/motg.c				1.7-1.8

	Trailing whitespace.
	Make this compile when DIAGNOSTIC isn't defined.
	[skrll, ticket #6]

usr.sbin/postinstall/postinstall		1.177-1.179

	Check for and delete ${DEST_DIR}/@RUNDIR@, not /@RUNDIR@.
	Also remove an unnecessary eval in do_dhcpcdrundir and
	fix a typo in the description.
	Quoting fixes in several eval commands.
	In get_makevar, ask make to recursively expand the variable,
	not just print the unexpanded value.  This is done by
	using make -V '${VAR}' instead of make -V 'VAR'.
	[apb, ticket #8]


usr.sbin/postinstall/postinstall		1.176

	FONTCONFIG_DIR not existing does not need to be fixed.
	[apb, ticket #9]

sys/arch/sparc64/sparc64/autoconf.c		1.199

	Match firmware paths for the boot device in Mac style, as used by
	QEMU/OpenBIOS.
	[martin, ticket #2]

sys/arch/sparc/sparc/autoconf.c			1.258

	Add device name mapping for "qfe" (quad hme) cards. PR#49103.
	[martin, ticket #7]

sys/dev/usb/xhci.c				1.25

	Serialise xhci_intr1 calls with sc_intr_lock.  From Takahiro HAYASHI.
	[skrll, ticket #11]

sys/dev/usb/files.usb				1.133
sys/dev/usb/usb.h				1.108

	Add XHCI_DEBUG.
	[skrll, ticket #12]

sys/arch/sparc64/sparc64/locore.s		1.370

	Add missing delay slot in DEBUG kernel.
	[nakayama, ticket #14]

sys/arch/x86/pci/if_vmx.c			1.5

	Set ifflags callback so that the device can enter promiscuous mode.
	[hikaru, ticket #15]

sys/dev/usb/usb.h				1.107

	Define AXEN_DEBUG.  From Takahiro HAYASHI.
	[skrll, ticket #10]

sys/crypto/cprng_fast/cprng_fast.c		1.7-1.10

	Access to struct cprng_fast must be consistently at IPL_VM.
	Use percpu_foreach instead of manual iteration.
	Move initial entropy bookkeeping out of the fast path.
	Tweak cprng_fast_buf to use 32-bit unaligned writes if possible.
	[riastradh, ticket #16]

distrib/amd64/cdroms/Makefile.cdrom		1.11
distrib/i386/cdroms/Makefile.cdrom		1.31
distrib/sparc64/cdroms/installcd/Makefile	1.19
distrib/vax/cdroms/installcd/Makefile		1.9

	CD images need libarchive if MKBSDTAR is yes.
	[riastradh, ticket #17]

sys/external/bsd/drm2/include/linux/pci.h	1.8
sys/external/bsd/drm2/ttm/ttm_agp_backend.c	1.2
sys/external/bsd/drm2/ttm/ttm_agp_backend.c	1.3

	Fix shifts & masks in Linux pci_read_config_{word,byte}.
	Use ttm_dma_tt_init in ttm_agp_tt_create so we can use ttm_bus_dma.
	Zero ttm_agp objects on creation.
	[riastradh, ticket #18]

distrib/sets/lists/debug/mi			1.82

	Add tar.debug and cpio.debug to lists for MKBSDTAR=yes MKDEBUG=yes.
	[riastradh, ticket #19]

distrib/sets/lists/modules/md.amd64		1.42

	Add dtrace modules to amd64-xen module set list.  Hi jnemeth!
	[riastradh, ticket #21]

sys/kern/subr_cprng.c				1.25

	Lock cprng->cs_lock around rndsink_request to avoid race with callback.
	[riastradh, ticket #22]

sys/kern/init_main.c				1.459
sys/rump/librump/rumpkern/rump.c		1.309
sys/rump/librump/rumpkern/rump.c		1.310

	Defer cprng_fast_init until CPUs are detected.
	Restore placement of percpu_init in rump_init.
	Probably doesn't matter, but let's avoid needless churn around the
	real bug fix.
	[riastradh, ticket #23]

sys/kern/subr_prf.c				1.155

	Avoid calling into time code when cold, and avoid calling nanotime()
	if we're not going to use the result anyway.
	Not necessarily the best fix, but better than crashing *early*
	boot due to too-early nanotime() calls.
	[mrg, ticket #24]

xsrc/external/mit/libdrm/dist/radeon/radeon_bo_gem.c	1.4

	convert an mmap() to drmMap().
	[mrg, ticket #25]

sys/kern/subr_prf.c				1.156

	If mutex_tryenter() fails, don't call mutex_exit().
	[apb, ticket #26]

build.sh					1.295

	Only the -m command line option, not MACHINE from the environment,
	is supposed override MACHINE_ARCH from the environment with the
	default MACHINE_ARCH for the requested machine.
	[apb, ticket #27]

sys/rump/net/lib/libshmif/if_shmem.c		1.63
sys/rump/net/lib/libshmif/shmifvar.h		1.8-1.9

	Make shmif work with bridges.
	[ozaki-r, ticket #28]

sbin/mount_ptyfs/mount_ptyfs.8			1.14
sys/fs/ptyfs/ptyfs.h				1.13-1.14
sys/fs/ptyfs/ptyfs_subr.c			1.30-1.32
sys/fs/ptyfs/ptyfs_vfsops.c			1.51-1.53
sys/fs/ptyfs/ptyfs_vnops.c			1.48-1.49

	Sync ptyfs with recent changes:
	 + Change ptyfs to vcache.
	  - Use (type, minor) as key.
	  - Change ptyfs_allocvp to return a referenced vnode and lock where
	    needed.
	  - Remove unneeded vnode backpointer ptyfs_vnode.
	  - Keep a single hashlist for pty nodes to make their attributes
	    persistent.
	 + Add a map of active controlling ptys per mount and no longer abuse
  	   the vnode lifecycle.
	 + No longer set "recycle" on VOP_INACTIVE().
	 + Make ptyfs_used_get() private to ptyfs_subr.c
	 + Stop copying device attributes from traditional ptys on first
	   allocation.
	 + Remove unneeded argument "lwp" from ptyfs_allocvp() and
	   ptyfs_free_get().
	[hannken, ticket #29]

sys/kern/exec_elf.c				1.70

	Eliminate COMPAT_OLDNOTE and just always recognize the old notes.
	[chs, ticket #32]

external/bsd/bind/Makefile.inc			1.22

	ALLOW_FILTER_AAAA_ON_V4 has been renamed to ALLOW_FILTER_AAAA
	(John D. Baker)
	[christos, ticket #33]

usr.bin/sed/process.c				1.46

	PR/49109: Jeremie Le Hen: fix sed relative addressin (1,+N)
	https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=192108
	http://svnweb.freebsd.org/base?view=revision&revision=269302
	[christos, ticket #34]

sys/external/bsd/drm2/dist/drm/drm_gem.c	1.5
sys/external/bsd/drm2/dist/drm/ttm/ttm_bo.c	1.5
sys/external/bsd/drm2/dist/drm/ttm/ttm_bo.c	1.6
sys/external/bsd/drm2/ttm/ttm_bo_vm.c		1.3

	bus_space_mmap cookies are not paddrs, so don't pmap_enter them.
	For gem and ttm objects backed by uvm_aobjs, share the vmobjlock.
	Simplify previous.
	[riastradh, ticket #36]

external/gpl3/gcc/dist/gcc/config/vax/builtins.md 1.4
external/gpl3/gcc/dist/gcc/config/vax/vax.c	1.10
lib/libc/compiler_rt/Makefile.inc		1.26
libexec/ld.elf_so/arch/vax/rtld_start.S		1.23-1.24

	Rework so that the ctzsi builtin is supported.
	VAX does need __clzsi2.
	Add a missing register prefix.
	Add proper registers for register counts.
	[matt, ticket #37]

sbin/ccdconfig/ccdconfig.c			1.54-1.55
sys/dev/ccd.c					1.152
sys/dev/ccdvar.h				1.34

	Switch size_t to uint64_t in appropriate places to ensure that 
	ccd(4) works with component and total sizes of > 2TB.
	Add COMPAT_60 code for platforms where this alters userland-accessible
	structures.
	Make kernel print device information when a ccd configured.
	Fix some typos in comments.
	Use correct printf format when printing sizes.
	[sborrill, ticket #38]

sys/rump/librump/rumpkern/hyperentropy.c	1.4-1.7

	Call rnd_add_data asynchronously for the rump hyperentropy callback. 
	Avoids recursion rnd_getmore -> rnd_add_data -> rnd_getmore.
	Add sys/atomic.h and order headers correctly.
	Fix header ordering.
	<sys/param.h> comes first, per /usr/share/misc/style.
	[riastradh, ticket #35]

doc/CHANGES					1.120 (CHANGES.prev)
	Formatting fixes, following the guidelines in the comments
	at the top of CHANGES.
	[apb, ticket #30]

share/man/man4/options.4			1.440
	Document options COMPAT_40, COMPAT_50, and COMPAT_60.
	[apb, ticket #31]

xsrc/external/mit/xf86-video-nv/dist/src/nv_driver.c	1.5
external/mit/xorg/server/drivers/xf86-video-nv/Makefile 1.7
	Put pci_device_has_kernel_driver(dev) into
	#if NV_TEST_FOR_KERNEL_DRIVER to make it work on non-x86 again.
	Mention NV_TEST_FOR_KERNEL_DRIVER and explain why it isn't enabled
	for now.
	[macallan, ticket #40]

sys/arch/arm/omap/omapfb.c			1.27
	Do not assume that PAGE_SIZE is 4kB always.
	[macallan, ticket #41]

share/man/man8/man8.x86/boot.8			1.3-1.4
	Document fs, menu, rndseed, and splash commands.
	Add rescue(8) to SEE ALSO.
	Document supported subsets of image formats.
	[apb, ticket #42]

sys/miscfs/umapfs/umap_vfsops.c			1.94
	Fix error return in mount with value not holding an error code.
	Bounds check a user controllable copyin size.
	Both triggerable from root only.
	[maxv, ticket #43]

sys/altq/altq_jobs.c				1.7
	Fix error branches to avoid leaks, noted by maxv@.
sys/dev/ic/oosiop.c				1.14
	Fix leaks in oosiop_alloc_cb error branches, noted by maxv@.
	While here, avoid a sketchy pointer cast that probably falls afoul
	of strict aliasing rules.
sys/dev/qbus/if_qe.c				1.73
	Avoid leak in error branch, noted by maxv@, compile-tested for vax.
sys/dev/rasops/rasops.c				1.72
	Don't leak f on failure.  Noted by maxv@.
sys/dev/vme/if_ie_vme.c				1.31
	Sizeof struct ievme, not sizeof size_t.
	Noted by maxv@, compile-tested for sparc.
sys/net/if_gre.c				1.160
	Don't leak in gre_clone_create error branch.
	Noted by maxv@, compile-tested for amd64.
	[riastradh, ticket #44]

sys/external/bsd/drm2/dist/drm/i915/i915_drv.h	1.8
sys/external/bsd/drm2/i915drm/files.i915drmkms	1.6
	Restore Intel opregion stuff.
	[riastradh, ticket #45]

sys/external/bsd/drm2/dist/drm/i915/i915_gem.c	1.15
sys/external/bsd/drm2/ttm/ttm_bo_vm.c		1.4
	Do not take the {ttm,gem} vmobjlock in the fault handler.
	 - We don't need this lock.
	 - uvm does nothing between taking it and calling the fault handler.
	 - Now that the uvm_aobj shares vmobjlock with the {ttm,gem} uvm
	   object, we must not hold the lock when we call uvm_obj_wirepages on
	   the uvm_aobj.
	[riastradh, ticket #46]

sys/external/bsd/common/include/linux/list.h	1.5
	Add some Linux list routines.
	[riastradh, ticket #47]

sys/dev/ic/mfi.c				1.54-1.55
	Fix mfi(4) panic on boot on some mfi(4) chips.
	[msaitoh, ticket #48]

sys/ufs/ext2fs/ext2fs_vfsops.c			1.184
	Use mount from argument "mp", "vp->v_mount" is not valid here.
	PR kern/49142 (panic in ext2fs_loadvnode mounting an ext2fs
	filesystem)
	[hannken, ticket #49]

usr.sbin/sysinst/disks.c			1.5
usr.sbin/sysinst/main.c				1.4-1.5
usr.sbin/sysinst/mbr.c				1.3
usr.sbin/sysinst/net.c				1.3-1.4
usr.sbin/sysinst/partman.c			1.5-1.6
usr.sbin/sysinst/util.c				1.4

	Remove some duplicate code, null termination, check
	return values, avoid NULL dereference in sysinst.
	[martin, ticket #39]

sys/dev/isa/ess.c				1.81-1.82
sys/dev/isa/essreg.h				1.17
sys/dev/isa/essvar.h				1.27

	Add support for Spatializer, 3D audio effects embedded in ES1869
	and ES1879 to ess(4).
	[nakayama, ticket #50]

sys/netinet6/ip6_output.c			1.158
sys/rump/librump/rumpvfs/rumpfs.c		1.130

	Fix memory leaks in error cases.
	[maxv, ticket #51]

lib/libperfuse/ops.c				1.67-1.69
lib/libperfuse/perfuse.c			1.32-1.33
lib/libperfuse/perfuse_priv.h			1.33-1.34
lib/libpuffs/dispatcher.c			1.47
lib/libpuffs/puffs.h				1.125
lib/libpuffs/puffs_ops.3			1.37-1.38
sys/fs/puffs/puffs_msgif.h			1.81
sys/fs/puffs/puffs_sys.h			1.85
sys/fs/puffs/puffs_vnops.c			1.183
usr.sbin/perfused/msg.c				1.22

	Implement FUSE direct I/O.
	Remove useless code and warnings
	[manu, ticket #52]

sys/arch/sparc/dev/fd.c				1.155
sys/arch/sparc64/dev/fdc.c			1.42
sys/arch/sun3/dev/fd.c				1.78

	Fix panic() on opening fd(4), caused by a wrong pointer passed
	to memset().
	[tsutsui, ticket #53]

sys/compat/osf1/osf1_file.c			1.42

	Fix a bug that a local user could crash the system by making the
	kernel perform a zero-sized memory allocation in osf1.
	[maxv, ticket #54]

sys/dev/dm/dm_target_stripe.c			1.20-1.21

	Avoid a memory leak - from maxv.
	Cleanup properly on error.
	[christos, ticket #55]

lib/libnpf/npf.c				1.33-1.34
sys/net/npf/npf_alg.c				1.15
sys/net/npf/npf_conn.c				1.11-1.12
sys/net/npf/npf_ctl.c				1.39-1.40
sys/net/npf/npf_impl.h				1.59
sys/net/npf/npf_nat.c				1.33
sys/net/npf/npf_nat.c				1.34
usr.sbin/npf/npfctl/npfctl.c			1.43

	Add and use npf_alg_export().
	npf_conn_import: handle NAT metadata correctly.
	npf_nat_newpolicy: restore the policy ID.
	npfctl_load: fix error code handling for the limit cases.
	npf_config_import: fix the inverted logic.
	npfctl_load: improve error handling.
	npf_conn_import: add a missing stat counter increment.
	npf_nat_import: add a missing reference and make a comment.
	npf_config_submit: finally, include the saved connections.
	[rmind, ticket #56]

sys/arch/arm/allwinner/awin_mmc.c		1.4
sys/arch/arm/allwinner/awin_reg.h		1.15

	Correct the mmc clock.  Banana Pi can now find an SD card.
	[skrll, ticket #57]

common/lib/libc/gen/rb.c			1.12-1.13

	Fix failure case in rb_tree_find_node_leq/geq.
	Return NULL, not `NULL - offset'.
	Remove enclosing parens on return.
	[riastradh, ticket #59]

external/mit/xorg/server/drivers/xf86-video-openchrome/Makefile 1.6

	Fix the sources list to match the upstream Makefile.am.
	Fixes problems reported by jdbaker.
	[mrg, ticket #60]

sys/dev/pci/if_wm.c				1.290
sys/dev/pci/if_wmvar.h				1.20

	Set the WM_F_ATTACHED flag if wm_attach() finished succesfully and check
	the flag in wm_detach(). It will avoid to panic in wm_detach().
	Fixes PR#49102.
	[msaitoh, ticket #61]

distrib/sets/lists/man/mi			1.1486
share/man/man4/Makefile				1.617
share/man/man4/arcofi.4				1.1-1.2
sys/arch/hp300/conf/GENERIC			1.188
sys/arch/hp300/conf/files.hp300			1.89
sys/arch/hp300/conf/majors.hp300		1.26
sys/arch/hp300/dev/arcofi_dio.c			1.1
sys/arch/hp300/hp300/intr.c			1.41
sys/arch/hp300/hp300/locore.s			1.171
sys/conf/files					1.1100
sys/dev/ic/arcofi.c				1.1
sys/dev/ic/arcofivar.h				1.1

	Add new arcofi(4) audio driver for NetBSD/hp300, ported from OpenBSD.

	The arcofi(4) is a driver for the HP "Audio1" device
	(Siemens PSB 2160 "ARCOFI" phone quality audio chip)
	found on the HP9000/425e and HP9000/{705,710,745,747} models
	(but only hp300 attachment is ported for now).
	The chip supports 8-bit mono 8kHz U-law, A-law and
	16-bit mono slinear_be formats.

	The old HP9000/425e playing tunes with this new arcofi(4) audio driver
	was also demonstrated at Open Source Conference 2014 Shimane.

	Add a man page for arcofi(4) driver.  From OpenBSD.
	Fix date.
	[tsutsui, ticket #62]

tests/lib/libpthread/t_swapcontext.c		1.2

	Go back to the initial context (as tests/lib/libc/sys/t_swapcontext.c
	does) after checking pthread_self() didn't change. Otherwise the
	process exits outside of atf context.
	Should fix "Test case exited normally but failed to create the results
	file: Results file is empty" reports from atf-run.
	[bouyer, ticket #63]

usr.bin/ldd/elf64/Makefile			1.8

	Fix ldd on LP64 platforms by splitting the symbol versioning stuff for
	elf64 as well.
	[joerg, ticket #64]

sys/dev/dkwedge/dk.c				1.73

	Make dk(4) discard from partition start, not from disk start.

	Otherwise, anything mounted with `-o discard' will pretty quickly
	munch itself up and barf up an unrecoverably corrupted file system!
	[riastradh, ticket #65]

sys/external/bsd/drm2/dist/drm/radeon/atombios_dp.c 1.3

	Hack around an evergreen attach crash for now: provide a hard coded
	name for the i2c.
	[mrg, ticket #66]

sys/fs/puffs/puffs_msgif.c			1.95
sys/fs/puffs/puffs_node.c			1.32
sys/fs/puffs/puffs_sys.h			1.86
sys/fs/puffs/puffs_vfsops.c			1.114
sys/fs/puffs/puffs_vnops.c			1.184

	Change puffs from hashlist to vcache.
	Field "pa_nhashbuckets" of struct "puffs_kargs" becomes a no-op
	and should be removed on the next protocol version bump.
	[hannken, ticket #67]

usr.bin/flock/flock.1				1.10
usr.bin/flock/flock.c				1.9-1.11

	Annotate functions using format strings.
	Improve Linux compatibility, by making exclusive lock the default.
	Also check for file descriptor value being sane.
	[manu, ticket #68]

sys/kern/subr_tftproot.c			1.13

	Fix build with TFTPROOT option enabled.
	[manu, ticket #69]

external/gpl3/gdb/dist/gdb/sparc-nat.c		1.7

	Cleanup the confusion with getting the pid of a sparc debugged process.
	If the comments were correct, then this should be factored out to the
	OS-specific native code, and the general code should remain sane.
	[christos, ticket #70]

lib/libperfuse/ops.c				1.70

	We used to remove the trailing zeros in FUSE readlink replies, but
	it seems it does not always happen. Just remove them if present.
	[manu, ticket #71]
