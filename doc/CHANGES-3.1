#	$NetBSD: CHANGES-3.1,v 1.1.2.18 2006/01/20 22:58:28 riz Exp $

A complete list of changes from the NetBSD 3.0 release to the NetBSD 3.1
release:

File						Revision(s)
----						--------
gnu/usr.bin/groff/tmac/mdoc.local		patch
sys/sys/param.h					patch

	Welcome to 3.0_STABLE

doc/README.files				patch

	Update for release and new CHANGES-3.1 file.

usr.sbin/pkg_install/add/perform.c		1.115

	(pkg_do) When marking already installed package as manually installed,
	only print message if we succeeded.
	[dillo, ticket #1039]

sys/dev/mii/brgphy.c				1.24-1.25
sys/dev/mii/miidevs				1.61
sys/dev/mii/miidevs.h				regen
sys/dev/mii/miidevs_data.h			regen

	Add support for bcm5714 phys.
	[jonathan, ticket #1044]

sys/dev/scsipi/sd.c				1.242-1.243

	Some USB devices reports themselves as removable, but have no door and
	so don't support the SCSI_PREVENT_ALLOW_MEDIUM_REMOVAL command.
	When an "Illegal field in CDB" is reported for this command, mark the
	device as non-removable (which is always true for USB keys from the SCSI
	point of view), print a message and ignore the error.
	For DIOCLOCK, return ENOTTY if the device is not removable instead of
	trying a command which will fail.
	[bouyer, ticket #1045]

usr.bin/gzip/gzip.c				1.81

	Remove unhandled H option from getopt() argument.
	Describe -l in usage. Both from Igor Sobrado in private mail.
	While here, sort options.
	[wiz, ticket #1053]

sys/netinet/udp_usrreq.c			1.144

	Fix a bug in ESP over UDP: because udp4_espinudp() called m_pullup, it
	could modify the struct mbuf and calling functions (udp_input() and
	udp4_realinput()) would have used a garbled local copy of the pointer.
	The fix is not perfect. udp4_espinudp() should use m_pulldown()...
	[manu, ticket #1052]

lib/libdes/ornd_keys.c				1.2

	Fix wrong buffer size calculation. From Henning Petersen in PR
	lib/32291.
	[martin, ticket #1056]

usr.bin/su/su.1					1.45 via patch

	Give a general description what this command does before going into
	all the details.
	[hubertf, ticket #1060]

share/mk/bsd.README				1.167

	document MKINET6 and USE_INET6
	[hubertf, ticket #1066]

lib/libc/gen/getcwd.c				1.41

	Allow last component to be non-existing again.
	This is what broke systrace's filename normalization.
	Go back to original behavior as in revision 1.35: return resolved name,
	but also set errno to ENOENT.
	[elad, ticket #1068]

sys/dev/pci/azalia.c				1.12-1.15
sys/dev/pci/azalia.h				1.1-1.3
sys/dev/pci/azalia_codec.c			1.1-1.3
sys/dev/pci/files.pci				1.239

	Improve support for ALC880/ALC882 codec.
	[kent, ticket #916]

sys/dev/ic/rtl81x9reg.h				1.14
sys/dev/pci/if_re_pci.c				1.12

	PR/32386: Dawid Szymanski (arhea). Add support for the 8169SB chipset.
	From FreeBSD.
	[rpaulo, ticket #1070]

sys/kern/kern_subr.c				1.122

	hold kernel_lock while calling systrace_exit().
	fixes PR 25856.
	[chs, ticket #1072]

sbin/newfs/newfs.8				1.67 via patch

	Xref newfs_msdos, noted by rabioli on Freenode #NetBSD
	[hubertf, ticket #1073]

sys/kern/kern_systrace.c			1.50 via patch

	in systrace_make_msg(), sleep uninterruptibly while waiting for
	the response from the systrace daemon, so that the message protocol
	between the kernel and the daemon doesn't get out of sync.
	fixes PR 29654.
	[chs, ticket #1071]

sys/arch/i386/i386/est.c			1.13

	PR kern/32418: Support for the Pentium M 770.
	[xtraeme, ticket #1075]

xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/nv_dac.c 1.8
xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/nv_driver.c 1.7
xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/nv_hw.c 1.2
xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/nv_include.h 1.2
xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/nv_setup.c 1.7
xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/nv_type.h 1.6
xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/nv_video.c 1.2
xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/riva_driver.c 1.2
xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/riva_include.h 1.2

	Sync the Nvidia drivers with XFree86's sources as of December 24th,
	2005.  These changes fix lots of problems (i.e. freezes) with the
	latest cards (such as a GeForce 6600GT).
	[jmmv, ticket #1074]

sys/arch/sparc64/dev/consinit.c			1.20

	Check the PROM stdin path for the string "/usb@0".  If we find a
	match, call ukbd_cnattach(), so that the USB keyboard will become
	the console keyboard.  Makes the keyboard work on a Blade 100. 
	[jdc, ticket #1076]

lib/libc/gen/getcwd.c				1.42

	Revert back to revision 1.40, as requested by cube@.
	Unbreaks KDE.
	[elad, ticket #1077]

bin/systrace/intercept.c			1.26
bin/systrace/intercept.h			1.18

	Give systrace its own version of realpath() that does what it wants,
	call it intercept_realpath().  Unbreaks systrace.
	[elad, ticket #1078]

sys/arch/i386/i386/identcpu.c			1.19

	Add missing entries in cache information array for, at least,
	Pentium M 770, 760, 750, 740 and 730.
	[tron, ticket #1079]

xfree/xc/programs/Xserver/hw/netbsd/alpha/alphaFbs.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/amiga/amigaFbs.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/dec/decFbs.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/dreamcast/dreamcastScreen.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/hpc/hpcScreen.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/macppc/macppcFbs.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/newsmips/newsmipsScreen.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/pmax/pmax_io.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/vax/mono_io.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/x68k/x68kFb.c 1.2

	XFree86 4.x now passes SCREEN_SAVER_CYCLE to the display driver.  The
	netbsd non-xfree86 servers treated this as an unblank event.  If the
	server is set to prefer blanking, and has a cycle time, the sreen will
	initially blank when the screen saver activates, and then unblank after
	the cycle time and stay unblanked.  Treat the SCREEN_SAVER_CYCLE state
	the same as SCREEN_SAVER_ON to keep the display blanked.
	[mhitch, ticket #1080]

gnu/dist/binutils/bfd/elf32-sh.c		1.2

	Don't reset relocation for R_SH_REL32 in shared objects if the
	symbol is locally called.  Makes hidden and protected symbols
	in shared objects work.
	[uwe, ticket #1081]

gnu/dist/gdb/gdb/shnbsd-tdep.c			1.4

	Handle the case when control transfer instruction jumps to its own
	delay slot (e.g. PLT entries use such code).  We can not set the
	breakpoint there, as trapa is illegal in the delay slot.  Set the
	breakpoint to the next instruction instead.  We are guaranteed to
	arrive there, as control transfers are illegal in the delay slot.
	[uwe, ticket #1082]

sys/arch/xen/conf/files.xen			1.29
sys/arch/xen/xen/hypervisor.c			1.16
sys/arch/xen/xen/if_xennet.c			1.31
sys/arch/xen/xen/xbd.c				1.22

	Define a xendevbus attribute and add it to hypervisor.  Use it for
	xen devices which attach to hypervisor. This allows to use
	config_found_ia() instead of config_found(), instead of relying
	on the order of which device are written in ioconf.c.
	[bouyer, ticket #1083]

sys/arch/xen/xen/if_xennet.c			1.32,1.36

	Replace MEXTMALLOC/memcpy with m_copyback().
	[bouyer, ticket #1084]

sys/arch/xen/i386/hypervisor_machdep.c		1.13
sys/arch/xen/include/hypervisor.h		1.15
sys/arch/xen/xen/hypervisor.c			1.17

	inline 2 trivial functions that are called often (according to
	profiling data).
	[bouyer, ticket #1085]

sys/dev/pci/pcidevs				1.755
sys/dev/pci/pcidevs.h				regen
sys/dev/pci/pcidevs_data.h			regen
sys/dev/pci/viaide.c				1.27

	Add support for nForce430 ATA133 and SATA controllers. My disks now run
	at a decent speed.
	[manu, ticket #1086]

sys/dev/pci/pciide_common.c			1.29

	Fix forcing use of DMA mode for the generic pciide driver:
	default_chip_map() is called from pciide_attach() and at this point
	we don't know which drives are here. Just assume all drives are
	there and allocate DMA ressources for all of them.
	[bouyer, ticket #1087]

sbin/newfs/mkfs.c				1.93

	The -b option is really on fsck_ffs, not fsck.
	[hubertf, ticket #1088]

sys/fs/union/union_vfsops.c			1.32

	Change union_unmount() to not play with the fs root vnode explicitly.
	Let it get recycled along with all of the others. This is important
	as if the root vnode has already been reclaimed, then we get a panic
	when we try to vget it.  This addresses PR: kern/31382
	[wrstuden, ticket #1091]

sys/net/if_gif.h				1.11
sys/netinet/in_gif.c				1.45
sys/netinet6/in6_gif.c				1.43

	expire cached route. Fixes PR 22792.
	[mlelstv, ticket #1092]

lib/libpthread/arch/i386/pthread_switch.S	1.9
lib/libpthread/arch/sparc/pthread_switch.S	1.8
lib/libpthread/arch/sparc64/pthread_switch.S	1.9
lib/libpthread/arch/x86_64/pthread_switch.S	1.11

	Make libpthread really shared, i.e. not have text reocations.
	[skrll, ticket #1093]

share/man/man9/pfil.9				1.30 via patch

	pfil_add_hook() and pfil_remove_hook() return int, not void.
	[riz, ticket #1110]

sys/net/if_bridge.c				1.35

	Make sure we initialize all structs to 0.
	[christos, ticket #1111]

sys/dev/pci/pcidevs				1.753-1.1754
sys/dev/pci/pcidevs.h				regen
sys/dev/pci/pcidevs_data.h			regen

	- Spell NVIDIA as "NVIDIA" instead of "Nvidia".
	- Add entry for builtin ethernet of NVIDIA nForce4 chipset.
	[tron, ticket #1112]

lib/libpthread/arch/sh3/pthread_switch.S	1.6
sys/arch/sh3/include/asm.h			1.18-1.24

	Implement WARN_REFERENCES. Provide PIC macros. Adapt pthread_switch.S
	to new PIC macros that are now in <machine/asm.h>.
	[uwe, ticket #1094]

lib/libpthread/arch/sh3/_context_u.S		1.5

	In PIC code call setcontext(2) via PLT to avoid text reloc in the
	shared library.
	[uwe, ticket #1095]

lib/libpthread/arch/x86_64/pthread_switch.S	1.12

	Revert the locked_return_point change. This fixes PR bin/32479.
	[skrll, ticket #1115]

lib/libc/arch/sh3/gen/swapcontext.S		1.4-1.8

	Use PLT for PIC calls to avoid text reloc in the shared library.
	[uwe, ticket #1096]

lib/libc/arch/sh3/sys/syscall.S			1.6
lib/libc/arch/sh3/sys/exect.S			1.5
lib/libc/arch/sh3/sys/__syscall.S		1.6

	Replace with macros from SYS.h, no special treatment is necessary.
	Avoid open-coded calls to cerror.
	[uwe, ticket #1097]

sys/arch/sh3/include/setjmp.h			1.3

	Provide defines for offsets into the jump buffer.
	[uwe, ticket #1098]

lib/libpthread/arch/sh3/pthread_switch.S	1.7

	Use PLT for PIC calls to avoid text relocs in the shared library.
	[uwe, ticket #1099]

sys/arch/xen/xen/xbdback.c			1.16 via patch

	Avoid dom0 kernel crash when destroying a domain with active I/O going.
	[bouyer, ticket #1106]

sys/arch/xen/i386/npx.c				1.7

	Fix the FPU problems detected by paranoia on a NetBSD/Xen guest,
	PR port-xen/30977.
	[bouyer, ticket #1107]

lib/libc/arch/sparc/sys/ptrace.S		1.6-1.7

	Use __errno in the _REENTRANT case.
	[martin, ticket #1109]

sys/dev/raidframe/rf_netbsdkintf.c		1.193

	We need to mark used spares as failed if they encounter IO errors.
	[oster, ticket #1114]

sys/arch/xen/i386/pmap.c			1.14
sys/arch/xen/include/pmap.h			1.5
sys/arch/xen/xen/privcmd.c			1.6
sys/arch/xen/xen/xbdback.c			1.15
sys/arch/xen/xen/xennetback.c			1.12 via patch

	Add a vm_prot_t parameter to pmap_remap_pages(), and use it for
	the new PTE instead to always trying PG_RW and falling back to
	PG_RO if this fails.  Use uvm_map_checkprot() in IOCTL_PRIVCMD_MMAP
	and IOCTL_PRIVCMD_MMAP_BATCH to compute the appropriate
	vm_prot_t for pmap_remap_pages().  Thanks to Jed Davis for
	pointing out uvm_map_checkprot().
	[bouyer, ticket #1104]

sys/dev/ic/ninjascsi32.c			1.6

	- Fix diagnostic panic for unaligned DMA buffer.
	- Fix error cleanup path in attach.
	[itohy, ticket #1117]

