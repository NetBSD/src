#	$NetBSD: CHANGES-3.1,v 1.1.2.28 2006/02/03 05:25:03 riz Exp $

A complete list of changes from the NetBSD 3.0 release to the NetBSD 3.1
release:

File						Revision(s)
----						--------
gnu/usr.bin/groff/tmac/mdoc.local		patch
sys/sys/param.h					patch

	Welcome to 3.0_STABLE

doc/README.files				patch

	Update for release and new CHANGES-3.1 file.

usr.sbin/pkg_install/add/perform.c		1.115

	(pkg_do) When marking already installed package as manually installed,
	only print message if we succeeded.
	[dillo, ticket #1039]

sys/dev/mii/brgphy.c				1.24-1.25
sys/dev/mii/miidevs				1.61
sys/dev/mii/miidevs.h				regen
sys/dev/mii/miidevs_data.h			regen

	Add support for bcm5714 phys.
	[jonathan, ticket #1044]

sys/dev/scsipi/sd.c				1.242-1.243

	Some USB devices reports themselves as removable, but have no door and
	so don't support the SCSI_PREVENT_ALLOW_MEDIUM_REMOVAL command.
	When an "Illegal field in CDB" is reported for this command, mark the
	device as non-removable (which is always true for USB keys from the SCSI
	point of view), print a message and ignore the error.
	For DIOCLOCK, return ENOTTY if the device is not removable instead of
	trying a command which will fail.
	[bouyer, ticket #1045]

usr.bin/gzip/gzip.c				1.81

	Remove unhandled H option from getopt() argument.
	Describe -l in usage. Both from Igor Sobrado in private mail.
	While here, sort options.
	[wiz, ticket #1053]

sys/netinet/udp_usrreq.c			1.144

	Fix a bug in ESP over UDP: because udp4_espinudp() called m_pullup, it
	could modify the struct mbuf and calling functions (udp_input() and
	udp4_realinput()) would have used a garbled local copy of the pointer.
	The fix is not perfect. udp4_espinudp() should use m_pulldown()...
	[manu, ticket #1052]

lib/libdes/ornd_keys.c				1.2

	Fix wrong buffer size calculation. From Henning Petersen in PR
	lib/32291.
	[martin, ticket #1056]

usr.bin/su/su.1					1.45 via patch

	Give a general description what this command does before going into
	all the details.
	[hubertf, ticket #1060]

share/mk/bsd.README				1.167

	document MKINET6 and USE_INET6
	[hubertf, ticket #1066]

lib/libc/gen/getcwd.c				1.41

	Allow last component to be non-existing again.
	This is what broke systrace's filename normalization.
	Go back to original behavior as in revision 1.35: return resolved name,
	but also set errno to ENOENT.
	[elad, ticket #1068]

sys/dev/pci/azalia.c				1.12-1.15
sys/dev/pci/azalia.h				1.1-1.3
sys/dev/pci/azalia_codec.c			1.1-1.3
sys/dev/pci/files.pci				1.239

	Improve support for ALC880/ALC882 codec.
	[kent, ticket #916]

sys/dev/ic/rtl81x9reg.h				1.14
sys/dev/pci/if_re_pci.c				1.12

	PR/32386: Dawid Szymanski (arhea). Add support for the 8169SB chipset.
	From FreeBSD.
	[rpaulo, ticket #1070]

sys/kern/kern_subr.c				1.122

	hold kernel_lock while calling systrace_exit().
	fixes PR 25856.
	[chs, ticket #1072]

sbin/newfs/newfs.8				1.67 via patch

	Xref newfs_msdos, noted by rabioli on Freenode #NetBSD
	[hubertf, ticket #1073]

sys/kern/kern_systrace.c			1.50 via patch

	in systrace_make_msg(), sleep uninterruptibly while waiting for
	the response from the systrace daemon, so that the message protocol
	between the kernel and the daemon doesn't get out of sync.
	fixes PR 29654.
	[chs, ticket #1071]

sys/arch/i386/i386/est.c			1.13

	PR kern/32418: Support for the Pentium M 770.
	[xtraeme, ticket #1075]

xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/nv_dac.c 1.8
xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/nv_driver.c 1.7
xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/nv_hw.c 1.2
xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/nv_include.h 1.2
xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/nv_setup.c 1.7
xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/nv_type.h 1.6
xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/nv_video.c 1.2
xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/riva_driver.c 1.2
xfree/xc/programs/Xserver/hw/xfree86/drivers/nv/riva_include.h 1.2

	Sync the Nvidia drivers with XFree86's sources as of December 24th,
	2005.  These changes fix lots of problems (i.e. freezes) with the
	latest cards (such as a GeForce 6600GT).
	[jmmv, ticket #1074]

sys/arch/sparc64/dev/consinit.c			1.20

	Check the PROM stdin path for the string "/usb@0".  If we find a
	match, call ukbd_cnattach(), so that the USB keyboard will become
	the console keyboard.  Makes the keyboard work on a Blade 100. 
	[jdc, ticket #1076]

lib/libc/gen/getcwd.c				1.42

	Revert back to revision 1.40, as requested by cube@.
	Unbreaks KDE.
	[elad, ticket #1077]

bin/systrace/intercept.c			1.26
bin/systrace/intercept.h			1.18

	Give systrace its own version of realpath() that does what it wants,
	call it intercept_realpath().  Unbreaks systrace.
	[elad, ticket #1078]

sys/arch/i386/i386/identcpu.c			1.19

	Add missing entries in cache information array for, at least,
	Pentium M 770, 760, 750, 740 and 730.
	[tron, ticket #1079]

xfree/xc/programs/Xserver/hw/netbsd/alpha/alphaFbs.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/amiga/amigaFbs.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/dec/decFbs.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/dreamcast/dreamcastScreen.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/hpc/hpcScreen.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/macppc/macppcFbs.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/newsmips/newsmipsScreen.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/pmax/pmax_io.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/vax/mono_io.c 1.2
xfree/xc/programs/Xserver/hw/netbsd/x68k/x68kFb.c 1.2

	XFree86 4.x now passes SCREEN_SAVER_CYCLE to the display driver.  The
	netbsd non-xfree86 servers treated this as an unblank event.  If the
	server is set to prefer blanking, and has a cycle time, the sreen will
	initially blank when the screen saver activates, and then unblank after
	the cycle time and stay unblanked.  Treat the SCREEN_SAVER_CYCLE state
	the same as SCREEN_SAVER_ON to keep the display blanked.
	[mhitch, ticket #1080]

gnu/dist/binutils/bfd/elf32-sh.c		1.2

	Don't reset relocation for R_SH_REL32 in shared objects if the
	symbol is locally called.  Makes hidden and protected symbols
	in shared objects work.
	[uwe, ticket #1081]

gnu/dist/gdb/gdb/shnbsd-tdep.c			1.4

	Handle the case when control transfer instruction jumps to its own
	delay slot (e.g. PLT entries use such code).  We can not set the
	breakpoint there, as trapa is illegal in the delay slot.  Set the
	breakpoint to the next instruction instead.  We are guaranteed to
	arrive there, as control transfers are illegal in the delay slot.
	[uwe, ticket #1082]

sys/arch/xen/conf/files.xen			1.29
sys/arch/xen/xen/hypervisor.c			1.16
sys/arch/xen/xen/if_xennet.c			1.31
sys/arch/xen/xen/xbd.c				1.22

	Define a xendevbus attribute and add it to hypervisor.  Use it for
	xen devices which attach to hypervisor. This allows to use
	config_found_ia() instead of config_found(), instead of relying
	on the order of which device are written in ioconf.c.
	[bouyer, ticket #1083]

sys/arch/xen/xen/if_xennet.c			1.32,1.36

	Replace MEXTMALLOC/memcpy with m_copyback().
	[bouyer, ticket #1084]

sys/arch/xen/i386/hypervisor_machdep.c		1.13
sys/arch/xen/include/hypervisor.h		1.15
sys/arch/xen/xen/hypervisor.c			1.17

	inline 2 trivial functions that are called often (according to
	profiling data).
	[bouyer, ticket #1085]

sys/dev/pci/pcidevs				1.755
sys/dev/pci/pcidevs.h				regen
sys/dev/pci/pcidevs_data.h			regen
sys/dev/pci/viaide.c				1.27

	Add support for nForce430 ATA133 and SATA controllers. My disks now run
	at a decent speed.
	[manu, ticket #1086]

sys/dev/pci/pciide_common.c			1.29

	Fix forcing use of DMA mode for the generic pciide driver:
	default_chip_map() is called from pciide_attach() and at this point
	we don't know which drives are here. Just assume all drives are
	there and allocate DMA ressources for all of them.
	[bouyer, ticket #1087]

sbin/newfs/mkfs.c				1.93

	The -b option is really on fsck_ffs, not fsck.
	[hubertf, ticket #1088]

sys/fs/union/union_vfsops.c			1.32

	Change union_unmount() to not play with the fs root vnode explicitly.
	Let it get recycled along with all of the others. This is important
	as if the root vnode has already been reclaimed, then we get a panic
	when we try to vget it.  This addresses PR: kern/31382
	[wrstuden, ticket #1091]

sys/net/if_gif.h				1.11
sys/netinet/in_gif.c				1.45
sys/netinet6/in6_gif.c				1.43

	expire cached route. Fixes PR 22792.
	[mlelstv, ticket #1092]

lib/libpthread/arch/i386/pthread_switch.S	1.9
lib/libpthread/arch/sparc/pthread_switch.S	1.8
lib/libpthread/arch/sparc64/pthread_switch.S	1.9
lib/libpthread/arch/x86_64/pthread_switch.S	1.11

	Make libpthread really shared, i.e. not have text reocations.
	[skrll, ticket #1093]

share/man/man9/pfil.9				1.30 via patch

	pfil_add_hook() and pfil_remove_hook() return int, not void.
	[riz, ticket #1110]

sys/net/if_bridge.c				1.35

	Make sure we initialize all structs to 0.
	[christos, ticket #1111]

sys/dev/pci/pcidevs				1.753-1.1754
sys/dev/pci/pcidevs.h				regen
sys/dev/pci/pcidevs_data.h			regen

	- Spell NVIDIA as "NVIDIA" instead of "Nvidia".
	- Add entry for builtin ethernet of NVIDIA nForce4 chipset.
	[tron, ticket #1112]

lib/libpthread/arch/sh3/pthread_switch.S	1.6
sys/arch/sh3/include/asm.h			1.18-1.24

	Implement WARN_REFERENCES. Provide PIC macros. Adapt pthread_switch.S
	to new PIC macros that are now in <machine/asm.h>.
	[uwe, ticket #1094]

lib/libpthread/arch/sh3/_context_u.S		1.5

	In PIC code call setcontext(2) via PLT to avoid text reloc in the
	shared library.
	[uwe, ticket #1095]

lib/libpthread/arch/x86_64/pthread_switch.S	1.12

	Revert the locked_return_point change. This fixes PR bin/32479.
	[skrll, ticket #1115]

lib/libc/arch/sh3/gen/swapcontext.S		1.4-1.8

	Use PLT for PIC calls to avoid text reloc in the shared library.
	[uwe, ticket #1096]

lib/libc/arch/sh3/sys/syscall.S			1.6
lib/libc/arch/sh3/sys/exect.S			1.5
lib/libc/arch/sh3/sys/__syscall.S		1.6

	Replace with macros from SYS.h, no special treatment is necessary.
	Avoid open-coded calls to cerror.
	[uwe, ticket #1097]

sys/arch/sh3/include/setjmp.h			1.3

	Provide defines for offsets into the jump buffer.
	[uwe, ticket #1098]

lib/libpthread/arch/sh3/pthread_switch.S	1.7

	Use PLT for PIC calls to avoid text relocs in the shared library.
	[uwe, ticket #1099]

sys/arch/xen/xen/xbdback.c			1.16 via patch

	Avoid dom0 kernel crash when destroying a domain with active I/O going.
	[bouyer, ticket #1106]

sys/arch/xen/i386/npx.c				1.7

	Fix the FPU problems detected by paranoia on a NetBSD/Xen guest,
	PR port-xen/30977.
	[bouyer, ticket #1107]

lib/libc/arch/sparc/sys/ptrace.S		1.6-1.7

	Use __errno in the _REENTRANT case.
	[martin, ticket #1109]

sys/dev/raidframe/rf_netbsdkintf.c		1.193

	We need to mark used spares as failed if they encounter IO errors.
	[oster, ticket #1114]

sys/arch/xen/i386/pmap.c			1.14
sys/arch/xen/include/pmap.h			1.5
sys/arch/xen/xen/privcmd.c			1.6
sys/arch/xen/xen/xbdback.c			1.15
sys/arch/xen/xen/xennetback.c			1.12 via patch

	Add a vm_prot_t parameter to pmap_remap_pages(), and use it for
	the new PTE instead to always trying PG_RW and falling back to
	PG_RO if this fails.  Use uvm_map_checkprot() in IOCTL_PRIVCMD_MMAP
	and IOCTL_PRIVCMD_MMAP_BATCH to compute the appropriate
	vm_prot_t for pmap_remap_pages().  Thanks to Jed Davis for
	pointing out uvm_map_checkprot().
	[bouyer, ticket #1104]

sys/dev/ic/ninjascsi32.c			1.6

	- Fix diagnostic panic for unaligned DMA buffer.
	- Fix error cleanup path in attach.
	[itohy, ticket #1117]

lib/libcurses/touchwin.c			1.21

	Don't crash if asked to touch more lines than there are in a window.
	[jdc, ticket #1108]

sys/net/if_tap.c				1.7
share/man/man4/tap.4				1.5

	Set bit 0x2 of the first byte of the generated MAC address, to
	indicate it is a locally administered address.  Pointed out by
	Ignatios Souvatzis.
	[cube, ticket #1113]

sys/arch/i386/conf/GENERIC_LAPTOP		1.166

	Add commented out entries for BRIDGE_IPF, pf(4) and pflog(4) matching
	the entries in "GENERIC".
	[tron, ticket #1116]

lib/libwrap/hosts_access.c			1.18

	Use ntohl(host_address) so that RBL lookups work on little-endian hosts.
	Tested on alpha, i386 and sparc64.  Fixes PR#30402.
	[jdc, ticket #1118]

sys/dev/pci/pccbb.c				1.127

	Use aprint_debug() instead of printf() for obvious debug statement.
	[uwe, ticket #1120]

sys/arch/hpcsh/hpcsh/autoconf.c			1.17

	#include "opt_md.h" as this file uses MEMORY_DISK_* options.
	[uwe, ticket #1121]

sys/conf/files					1.752

	tap(4) depends on arp:  it is an Ethernet interface, after all.
	Solves PR#32548 by Pawel Chwalowski.
	[cube, ticket #1122]

sys/dev/pci/pcidevs				1.739
sys/dev/pci/pcidevs.h				regen
sys/dev/pci/pcidevs_data.h			regen
sys/dev/pci/pdcsata.c				1.4

	PR#32238: Ryo Shimizu: Add support for Promise SATA300TX4 SATA
	Controller (PDC40718)
	[simonb, ticket #1126]

sys/compat/ossaudio/ossaudio.c			1.48

	Fix problem in ioctl() handling in OSS audio emulation which caused
	unintentional changes of the audio settings e.g. when running "kphone".
	[tron, ticket #1127]

lib/libc/arch/sh3/gen/__setjmp14.S		patch
lib/libc/arch/sh3/gen/__sigsetjmp14.S		patch
lib/libc/arch/sh3/gen/setjmp.S			patch
lib/libc/arch/sh3/gen/sigsetjmp.S		patch

	Use PLT for PIC calls to avoids text relocs in the shared library.
	[uwe, ticket #1100]

lib/libc/arch/sh3/SYS.h				1.7-1.9
lib/libc/arch/sh3/sys/__clone.S			1.4-1.6
lib/libc/arch/sh3/sys/brk.S			1.10
lib/libc/arch/sh3/sys/cerror.S			1.8-1.10
lib/libc/arch/sh3/sys/fork.S			1.9
lib/libc/arch/sh3/sys/ptrace.S			1.7
lib/libc/arch/sh3/sys/sbrk.S			1.9
lib/libc/arch/sh3/sys/sigprocmask.S		patch
lib/libc/arch/sh3/sys/sigsuspend.S		patch

	Eliminate text relocations in libc.so.
	[uwe, ticket #1101]

lib/libc/arch/sh3/sys/__vfork14.S		1.6
lib/libc/arch/sh3/sys/Ovfork.S			patch

	Use JUMP_CERROR instead of messing with errno directly.
	Simplify.
	[uwe, ticket #1102]

lib/libc/arch/sh3/sys/ptrace.S			1.8

	Provide _REENTRANT version of errno = 0;
	[uwe, ticket #1103]

sys/arch/xen/include/if_xennetvar.h		1.8
sys/arch/xen/xen/if_xennet.c			1.33-1.35 via patch

	- Use MCLGET() instead of local list of buffers.
	- Garbage-collect struct xennet_txbuf usage.
	- Don't allocate cluster mbufs unless needed.
	- Remove no longer used macros.
	[bouyer, ticket #1105]

sys/dev/usb/ums.c				1.61-1.62

	- Support more than 7 buttons for USB mice. This fixes PR kern/30248.
	- Look for a wheel before looking for a Z dir. This makes Apple's
	  Mightymouse work.
	[uwe, ticket #1119]

sys/dev/pci/ehci_pci.c				1.22
sys/dev/usb/ehci.c				1.108
sys/dev/usb/ehcivar.h				1.23

	Add a workaround for VIA EHCI controllers to prevent unrecoverable
	umass(4) stalls.
	[xtraeme, ticket #1123]

sys/dev/ic/wdc.c 1.231

        After a reset don't wait for drives to come ready if there's no
        drives.  fix a 30s hang after resume. Problem reported and fix
	tested by Brian de Alwis.
	[bouyer, ticket #1125]

	tested by Brian de Alwis.
	[bouyer, ticket #1125]

lib/libc/rpc/xdr_rec.c				1.26

	John Kohl: xdr_rec.c missing a bugfix for an improper security
	check.  The correct way to check for a zero record length is to
	check for it without the LAST_FRAG marker in it, since it's legal
	to send a LAST_FRAG marker with 0 bytes of data.  PR#32572

	[christos, ticket #1128]

sys/dev/pci/azalia.c				1.17-1.19
sys/dev/pci/azalia.h				1.5-1.6
sys/dev/pci/azalia_codec.c			1.5-1.7

	- Code cleanup.
	- Various bug fixes including PR port-i386/32485.
	- Support for 8ch playback with STAC9221D codec.
	[kent, ticket #1124]

distrib/amiga/stand/Makefile			1.2
distrib/amiga/stand/loadbsd-2.14.gz.uue		delete
distrib/amiga/stand/loadbsd-2.16.gz.uue		delete
distrib/amiga/stand/loadbsd-2.16.uue		1.1
distrib/amiga/stand/rdbinfo.gz.uue		delete
distrib/amiga/stand/xstreamtodev.gz.uue		delete

	Only provide uncompressed tools, so that they can be run directly
	from CD-ROM, and buggy CD-ROM file systems aren't confused by two
	tools with the same prefix.
	[is, ticket #1129]

distrib/amiga/miniroot/install.md		1.25
distrib/miniroot/install.sh			1.23
distrib/miniroot/upgrade.sh			1.21

	Don't ask for the root device before the user had a chance to
	identify how it's called under NetBSD.
	[is, ticket #1130]

sys/arch/i386/pnpbios/pciide_pnpbios.c		1.22 via patch

	Update pciide at pnpbios to work with the last changes to wdc(4),
	especially the deferral of drive probe. This fixes PR kern/23192.
	[bouyer, ticket #1131]

sys/dev/ata/wd.c				1.318

	Fix support for 1 and 2TB disks (tested under qemu).
	[abs, ticket #1132]

sys/arch/i386/i386/est.c			1.15

	PR port-i386/32606: Add support for the Pentium M 710.
	[xtraeme, ticket #1134]

sys/dev/pci/auixp.c				1.11

Duh! If askes to halt the input dont halt the output instead. This also
fixes the timeout on draining when closing.
[reinoud, ticket #1138]

sys/dist/pf/net/pf_norm.c			1.11

	Fix a bug in the fragment cache which could cause kernel panics.
	[peter, ticket #1139]

lib/libc/stdio/fseek.c				1.22

	Must include "namespace.h" for fseeko()'s internal name.
	[kleink, ticket #1140]

lib/libc/include/namespace.h			1.110
lib/libc/rpc/mt_misc.c				1.5

	Need to give the various rpc locks private names (prefixing them with
	__rpc_).  Rather than scattering changes around the 3rd-party RPC
	code, place them in namespace.h.
	[kleink, ticket #1142]

sys/sys/socket.h				1.78

	Since NULL isn't necessarily available, change CMSG_*() to use the
	integer constant expression directly instead.
	[kleink, ticket #1143]

share/termcap/termcap.src			1.95

	Wscons terminals only have 8 colours and don't need an NC entry.
	Fixes PR misc/32135 by Pavel Cahyna.
	[jdc, ticket #1144]

sys/arch/hp300/stand/common/ite_dv.c		1.6
sys/arch/hp300/stand/common/ite_gb.c		1.6
sys/arch/hp300/stand/common/ite_hy.c		1.6
sys/arch/hp300/stand/common/ite_rb.c		1.6
sys/arch/hp300/stand/common/ite_tc.c		1.6

	Fix bootloader so it doesn't print garbage to the bitmap console.
	[tsutsui, ticket #1145]

sys/arch/mac68k/dev/sbc.c			1.49

	Add fault-protection in sbc_pdma_in() like in all the other PDMA
	functions. This fixes PR port-mac68k/9679.
	[chs, ticket #1146]

sys/arch/sparc/include/param.h			1.64

	Increase NKMEMPAGES_MAX_DEFAULT to 32 MB. This is needed on sun4m
	machines with 512 MB of RAM, and it doesn't seem to cause any
	problems on sun4c.
	[chs, ticket #1147]

sys/dev/rcons/rcons_subr.c			1.16

	Avoid watchdog reset caused by output of certain characters on the
	console. This fixes PR port-sparc/29948.
	[chs, ticket #1148]

sys/dev/pci/viaide.c				1.28

	The NVidia nForce430 IDE Controller supports Ultra-DMA Mode 6,
	enable it.
	[xtraeme, ticket #1149]

libexec/ld.elf_so/rtld.c			1.109

	Fix a bug that showed up when debugging dynamically linked programs.
	References from GDB to "printf" and various other functions would
	find the versions in the dynamic linker itself, rather than the
	versions in the program's libc. This fixes PR toolchain/32074.
	[christos, ticket #1150]

sys/arch/i386/conf/XEN0				1.26

	Change number of vnd to 32 from 4, since many users of XEN0 will need
	more.
	[gdt, ticket #1151]

sys/net/if_pppoe.c				1.64

	Make sure error messages (received from the access concentrator) are
	zero terminated.
	[martin, ticket #1152]

sys/dev/pcmcia/aic_pcmcia.c			patch
doc/HACKS					patch

	aic(4): work around rbus resource allocation problem so cards work
	again.
	[jnemeth, ticket #1153]

