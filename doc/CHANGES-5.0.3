# $NetBSD: CHANGES-5.0.3,v 1.1.2.19 2010/09/22 22:52:27 snj Exp $

A complete list of changes from the NetBSD 5.0.2 release to the NetBSD 5.0.3
release:

gnu/usr.bin/groff/tmac/mdoc.local		patched by hand
sys/sys/param.h					patched by hand

	Welcome to 5.0.2_PATCH.
	[snj]

distrib/pmax/instkernel/Makefile		patch

	Bump the size of the pmax instkernel ramdisk to 2200k.
	[snj, ticket #1305]

external/bsd/fetch/dist/libfetch/common.c	patch
external/bsd/fetch/dist/libfetch/common.h	patch
external/bsd/fetch/dist/libfetch/errlist.sh	patch
external/bsd/fetch/dist/libfetch/fetch.3	patch
external/bsd/fetch/dist/libfetch/fetch.c	patch
external/bsd/fetch/dist/libfetch/fetch.cat3	patch
external/bsd/fetch/dist/libfetch/fetch.h	patch
external/bsd/fetch/dist/libfetch/file.c		patch
external/bsd/fetch/dist/libfetch/ftp.c		patch
external/bsd/fetch/dist/libfetch/ftp.errors	patch
external/bsd/fetch/dist/libfetch/http.c		patch
external/bsd/fetch/dist/libfetch/http.errors	patch

	Update libfetch to 2.30.
	libfetch-2.25:
	- address a number of lint warnings
	- fix strict-alignment issues for GCC 4.4
	- fix a bug in the line reading optimisation
	- do not reuse a FTP connection if there is an active transfer on it

	libfetch-2.26:
	- Add support to aggressively cache directory listenings, useful for
	  HTTP
	- Avoid leaking memory in error cases. From Xavier from Arch Linux.

	libfetch-2.30:
	- Revamped connection cache, allowing more than one active session
	- HTTP keep-alive support
	[joerg, ticket #1294]

external/bsd/pkg_install/dist/add/add.h			patch
external/bsd/pkg_install/dist/add/main.c		patch
external/bsd/pkg_install/dist/add/perform.c		patch
external/bsd/pkg_install/dist/add/pkg_add.1		patch
external/bsd/pkg_install/dist/admin/audit.c		patch
external/bsd/pkg_install/dist/admin/check.c		patch
external/bsd/pkg_install/dist/admin/main.c		patch
external/bsd/pkg_install/dist/admin/pkg_admin.1		patch
external/bsd/pkg_install/dist/bpm/bpm.1			patch
external/bsd/pkg_install/dist/bpm/bpm.sh.in		patch
external/bsd/pkg_install/dist/create/build.c		patch
external/bsd/pkg_install/dist/create/create.h		patch
external/bsd/pkg_install/dist/create/main.c		patch
external/bsd/pkg_install/dist/create/perform.c		patch
external/bsd/pkg_install/dist/create/pkg_create.1	patch
external/bsd/pkg_install/dist/create/pl.c		patch
external/bsd/pkg_install/dist/delete/pkg_delete.1	patch
external/bsd/pkg_install/dist/delete/pkg_delete.1.in	patch
external/bsd/pkg_install/dist/delete/pkg_delete.c	patch
external/bsd/pkg_install/dist/info/info.h		patch
external/bsd/pkg_install/dist/info/main.c		patch
external/bsd/pkg_install/dist/info/perform.c		patch
external/bsd/pkg_install/dist/info/pkg_info.1		patch
external/bsd/pkg_install/dist/info/show.c		patch
external/bsd/pkg_install/dist/lib/automatic.c		patch
external/bsd/pkg_install/dist/lib/conflicts.c		patch
external/bsd/pkg_install/dist/lib/decompress.c		patch
external/bsd/pkg_install/dist/lib/defs.h		patch
external/bsd/pkg_install/dist/lib/dewey.c		patch
external/bsd/pkg_install/dist/lib/fexec.c		patch
external/bsd/pkg_install/dist/lib/file.c		patch
external/bsd/pkg_install/dist/lib/global.c		patch
external/bsd/pkg_install/dist/lib/gpgsig.c		patch
external/bsd/pkg_install/dist/lib/iterate.c		patch
external/bsd/pkg_install/dist/lib/lib.h			patch
external/bsd/pkg_install/dist/lib/license.c		patch
external/bsd/pkg_install/dist/lib/lpkg.c		patch
external/bsd/pkg_install/dist/lib/opattern.c		patch
external/bsd/pkg_install/dist/lib/parse-config.c	patch
external/bsd/pkg_install/dist/lib/pkcs7.c		patch
external/bsd/pkg_install/dist/lib/pkg_install.conf.5.in	patch
external/bsd/pkg_install/dist/lib/pkg_io.c		patch
external/bsd/pkg_install/dist/lib/pkg_signature.c	patch
external/bsd/pkg_install/dist/lib/pkg_summary.5		patch
external/bsd/pkg_install/dist/lib/pkgdb.c		patch
external/bsd/pkg_install/dist/lib/plist.c		patch
external/bsd/pkg_install/dist/lib/remove.c		patch
external/bsd/pkg_install/dist/lib/str.c			patch
external/bsd/pkg_install/dist/lib/var.c			patch
external/bsd/pkg_install/dist/lib/version.c		patch
external/bsd/pkg_install/dist/lib/version.h		patch
external/bsd/pkg_install/dist/lib/vulnerabilities-file.c patch
external/bsd/pkg_install/dist/lib/xwrapper.c		patch
external/bsd/pkg_install/dist/x509/pkgsrc.cnf		patch
external/bsd/pkg_install/dist/x509/pkgsrc.sh		patch

	Update pkg_install to 20100204.

	pkg_install-20091115:
	Completely ignore @src in pkg_create. Silently ignore the -L option.
	The combination of -I and -p are used by pkgsrc for the same result.

	Do not overwrite a string with itself using snprintf. This breaks
	setting the pkgdb directory internally on Linux. Explicitly check
	if the string is the same and otherwise just use xstrdup.

	Add support to query arbitrary variables with pkg_admin config-var.

	pkg_install-20100130:
	- pkg_add -U to rplace an installed version
	- refactored man pages
	- PKG_DBDIR / PKG_REFCOUNT_DBDIR as pkg_install.conf options
	- synced license list
	- use connection cache from libfetch

	pkg_install 20100204:
	- Restore PKG_PREFIX in pkg_delete (PR 42731)                  
	- Ensure that the current pkg_install version is at least as new   
	  as the version used to build the package
	[joerg, ticket #1298]

sys/arch/i386/i386/ibcs2_machdep.c		1.40
sys/arch/i386/i386/svr4_machdep.c		1.96

	fix confused CS selector, fixes the panic reported by Mark Davis
	per PR port-i386/42787 (the panic happens due to a GPF when a
	privileged descriptor is tried to be loaded with the UPL bit set)
	The original bug is very old (pre-2.0, i386/svr4_machdep.c rev. 1.69),
	but it was relatively harmless until the order of GDT entries was
	shuffled (pre-5.0, i386/segments.h rev. 1.42). Before, it caused
	a userlevel data selector to be used for CS which broke the emulation
	(likely the reason of PR port-i386/32424). The shuffle made that
	a privileged selector was used, causing the GPF.
	(recent -current doesn't panic on that GPF which seems to be a
	side effect of another change)
	[drochner, ticket #1307]

tools/compat/getmode.c				1.8

	include unistd.h where getmode is traditionally declared.
	Fix build on OS X 10.6.
	[snj, ticket #1308]

sys/arch/hppa/hppa/vm_machdep.c 		patch

	Fix ticket #793: s/setfunc_trampoline/lwp_trampoline/.
	[skrll, ticket #1312]

crypto/dist/openssl/crypto/evp/m_sha1.c		patch

	Ensure that SHA384 always calls the SHA384 functions.
	Should fix PR#42881.
	[joerg, ticket #1320]

crypto/dist/openssl/ssl/s3_pkt.c		patch

	Apply patchset 19476 from openssl repository, fixing CVE-2010-0740.
	From http://www.openssl.org/news/secadv_20100324.txt:
	"In TLS connections, certain incorrectly formatted records can cause
	an OpenSSL client or server to crash due to a read attempt at NULL".
	[bouyer, ticket #1355]

sys/kern/uipc_syscalls.c			patch

	In do_sys_recvmsg(), call free(9) with the same type malloc(9) used.
	[jakllsch, ticket #1352]

crypto/dist/openssl/ssl/s3_enc.c		1.2 via patch
crypto/dist/openssl/ssl/s3_srvr.c		1.5 via patch
crypto/dist/openssl/ssl/t1_enc.c		1.2 via patch

	Fix crash in openssl: handshake_dgst[] may be used without being
	allocated, causing NULL pointer dereference.
	Fix by checking that handshake_dgst is not NULL before use.
	[bouyer, ticket #1365]

libexec/ftpd/popen.c				1.37
libexec/ftpd/version.h				1.74

	PR/43023: FTPD bug remote crash.  Since we specify NOCHECK, in the
	NOMATCH case gl_pathv can be NULL.
	Update version to 20100320.
	[lukem, ticket #1372]

external/bsd/openldap/dist/libraries/libldap/tls.c patch

	Fix CVE-2009-3767.
	[lukem, ticket #1374]

sys/arch/amd64/amd64/locore.S			1.56

	When kernel remaps to high memory in amd64 locore, the GDT used
	before becomes invalid. As such, split it in two parts, one for
	use when system boots in low memory, and one for use when it jumps
	to high memory.
	[jym, ticket #1376]

sys/arch/x86/x86/identcpu.c			1.19

	Fix a test semantic in cpu_probe(): check that the CPU currently
	probed is the first one booting by comparing its struct cpu_info
	address with cpu_info_primary, rather than supposing that
	cpu_feature variables are set to 0.
	[jym, ticket #1377]

sys/arch/amd64/amd64/locore.S			patch
sys/arch/amd64/amd64/machdep.c			patch
sys/arch/amd64/amd64/mptramp.S			patch
sys/arch/i386/i386/machdep.c			patch
sys/arch/i386/isa/npx.c				patch
sys/arch/x86/include/cpu.h			patch
sys/arch/x86/include/cpuvar.h			patch
sys/arch/x86/x86/cpu.c				patch
sys/arch/x86/x86/identcpu.c			patch
sys/arch/x86/x86/pmap.c				patch
sys/arch/xen/x86/cpu.c				patch

	Fix the NX regression issue observed on amd64 kernels, where
	per-page execution right was disabled (therefore leading to the
	inability of the kernel to detect fraudulent use of memory mappings
	marked as not being executable).
	[jym, ticket #1380]

sys/conf/copyright				1.7

	Welcome to 2010.
	[tsutsui, ticket #1388]

sys/arch/i386/i386/trap.c			1.251-1.253 via patch
sys/arch/i386/i386/vector.S			1.50-1.51 via patch

	If we fault on the 'iret' during return to userpace (eg if %eip is
	outside the bounds of %cs) then hack the stack to contain a normal
	fault frame for the signal setup code (etc).
	Previously the code assumed that the original user trap frame was
	still present - at it is for faults when loading the segment
	registers.
	--
	If we fault on the iret during return to userspace, see if we need
	to do a lazy update of %cs to make the stack executable.  If a
	change is made, just retry the failing sequence.  Signal handlers
	as gcc nested local functions now work!
	--
	Fix 'fault on load of %gs during retirn to userspace' to look for
	the correct instruction bytes.  Take the 'fault on load segment
	register' through the same path as 'fault on iret' so we don't have
	to fixup the broken stackframe that contains a mix of user and
	kernel registers. Update comments about how the faults during
	return to userspace are processed.  Setting an invalid %gs in the
	saved context of a signal handler causes a SIGSEGV handler to be
	entered with what look like valid registers.
	[riz, ticket #1401]

sys/arch/amd64/amd64/netbsd32_machdep.c		patch
sys/arch/i386/i386/trap.c			patch

	Fix several panics that can be caused by applications using
	bad segment register values with setcontext() or sigreturn().
	[chs, ticket #1424]

sys/netsmb/mchain.h				1.9
sys/netsmb/smb_dev.h				1.7
sys/netsmb/smb_subr.c				1.35
sys/netsmb/smb_subr.h				1.19
sys/netsmb/subr_mchain.c			1.19

	Convert sizes/lengths to unsigned (size_t) or uint32_t
	(for binary compatibility).
	[christos, ticket #1426]

sys/netinet6/udp6_output.c			1.41 via patch

	udp6_output(): call ip6_clearpktopts(&opt, ...) only if opt
	was initialized.
	[dyoung, ticket #1428]

crypto/dist/ssh/sftp-glob.c			patch
crypto/dist/ssh/sftp.c				patch
lib/libc/gen/glob.3				1.37 via patch
lib/libc/gen/glob.c				1.25-1.26

	Fix globbing in libc and sftp.
	[christos, ticket #1430]

sys/coda/coda.h					1.16
sys/coda/coda_venus.c				1.28
sys/coda/coda_vnops.c				1.76

	Correct incomplete size checks for the coda ioctls.
	[christos, ticket #1431]

sys/kern/exec_subr.c				1.65
sys/kern/kern_pax.c				1.24

	Fix issues with stack allocation and pax aslr:
	- since the size is unsigned, don't check just that it is > 0,
	  but limit it to the MAXSSIZ
	- if the stack size is reduced because of aslr, make sure we reduce
	  the actual allocation by the same size so that the size does not
	  wrap around.
	[christos, ticket #1444]

crypto/external/bsd/openssl/dist/ssl/s3_clnt.c	1.2 via patch

	fix CVE-2010-2939:
	a double free() in error case cause a SEGV, see the thread
	"openssl-1.0.0a and glibc detected sthg ;)" in openssl-dev.
	[drochner, ticket #1447]

sys/miscfs/genfs/genfs_io.c			1.40 via patch
sys/miscfs/genfs/genfs_node.h			1.20 via patch
sys/miscfs/genfs/genfs_vnops.c			1.183 via patch
sys/ufs/ufs/ufs_inode.c				1.83 via patch
sys/uvm/uvm_pager.h				1.39 via patch

	replace the earlier workaround for PR 40389 with a better fix.
	the earlier change caused data corruption by freeing pages
	without invaliding their mappings.  instead of the trylock/retry,
	just take the genfs-node lock before calling VOP_GETPAGES()
	and pass a new flag to tell it that we're already holding this lock.
	[chs, ticket #1448]

sys/arch/amd64/amd64/netbsd32_machdep.c		1.66, 1.67
sys/arch/amd64/include/segments.h		1.21

	in check_mcontext32(), accept the LDT selector for 32-bit user code
	as well as the GDT selector.  fixes PR 43835.
	accept the LDT selector in check_sigcontext32() too.
	[chs, ticket #1449]

dist/bzip2/decompress.c				1.2

	Avoid integer overflow that can lead to buffer overflow.
	[christos, ticket #1455]

