# $NetBSD: CHANGES-9.3,v 1.1.2.20 2021/08/08 10:23:51 martin Exp $

A complete list of changes from the NetBSD 9.2 release to the NetBSD 9.3
release:

external/gpl2/groff/tmac/mdoc.local		patched by hand
sys/sys/param.h 				patched by hand
doc/CHANGES-9.3					added

	Welcome to 9.2_STABLE.
	[martin]

sys/fs/ntfs/ntfs_subr.c				1.64

	PR 56160: fix a kernel crash for some NTFS file systems.
	[hannken, ticket #1272]

sys/dev/pci/xhci_pci.c				1.26

	PR 55855: avoid potential double free of interrupt handles.
	[jakllsch, ticket #1273]

external/cddl/osnet/dist/cmd/zfs/zfs_main.c	1.8
external/cddl/osnet/dist/lib/libzfs/common/libzfs_dataset.c 1.5

	zfs: this is not FreeBSD.
	[nia, ticket #1274]

xsrc/external/mit/libX11/dist/src/Font.c		(apply patch)
xsrc/external/mit/libX11/dist/src/FontInfo.c		(apply patch)
xsrc/external/mit/libX11/dist/src/FontNames.c		(apply patch)
xsrc/external/mit/libX11/dist/src/GetColor.c		(apply patch)
xsrc/external/mit/libX11/dist/src/LoadFont.c		(apply patch)
xsrc/external/mit/libX11/dist/src/LookupCol.c		(apply patch)
xsrc/external/mit/libX11/dist/src/ParseCol.c		(apply patch)
xsrc/external/mit/libX11/dist/src/QuExt.c		(apply patch)
xsrc/external/mit/libX11/dist/src/SetFPath.c		(apply patch)
xsrc/external/mit/libX11/dist/src/SetHints.c		(apply patch)
xsrc/external/mit/libX11/dist/src/StNColor.c		(apply patch)
xsrc/external/mit/libX11/dist/src/StName.c		(apply patch)
xsrc/external/mit/libX11/dist/src/xlibi18n/imKStoUCS.c	(apply patch)

	Apply upstream fixes for CVE-2021-31535 (and one other bug).
	Reject string longer than USHRT_MAX before sending them on the wire.
	Fix out-of-bound access in KeySymToUcs4().
	[mrg, ticket #1275]

external/mit/xorg/server/drivers/xf86-input-keyboard/Makefile 1.17

	Make wskbd(4) default for mac68k; no other protocol is available.
	[rin, ticket #1276]

sys/arch/aarch64/aarch64/netbsd32_machdep.c	1.18

	Fix conversion between aarch64 and aarch32 fpregs to fix crashes
	in VFP-optimized codes running on COMPAT_NETBSD32.
	[rin, ticket #1277]

sys/arch/aarch64/aarch64/aarch64_machdep.c	1.50,1.60,1.61

	Minor fix for aarch64 memory detection.
	[skrll, ticket #1278]

sys/arch/arm/arm32/arm32_boot.c			1.42,1.43

	Minor fix for ARM memory detection.
	[skrll, ticket #1279]

sys/arch/hp300/conf/INSTALL			1.67,1.68

	Add missing 'nhpib at intio' for internal HP-IB.
	Reduce maxusers to 8 (same as GENERIC).
	[tsutsui, ticket #1280]

distrib/miniroot/install.sub			1.60

	Handle recent ifconfig(8) output in the miniroot installation script.
	[tsutsui, ticket #1281]

sys/dev/pci/if_iwmreg.h				1.8

	iwm(4): fix various bit declarations - use unsigned for 2^32.
	[nia, ticket #1282]

sbin/dump/tape.c				1.56

	dump(8): prevent crashes for large file systems.
	[hannken, ticket #1283]

external/bsd/libpcap/bin/Makefile		1.3

	Fix pcap-config output.
	[dholland, ticket #1284]

usr.bin/ftp/ftp.c				1.170
usr.bin/ftp/version.h				1.90

	ftp(1): improve signal handler restoration.
	[lukem, ticket #1290]

usr.bin/ftp/ftp.c				1.169
usr.bin/ftp/util.c				1.161

	ftp(1): exit if lostpeer() is invoked by a signal.
	[lukem, ticket #1291]

usr.bin/ftp/fetch.c				1.232

	ftp(1): improve signal handler restoration.
	[lukem, ticket #1292]

usr.bin/ftp/ftp.c				1.172

	ftp(1): PR 56129: attempt to prevent timeouts of the control
	connection.
	[lukem, ticket #1293]

usr.bin/ftp/cmds.c				1.141
usr.bin/ftp/ftp.1				1.143

	ftp(1): fix description of "debug".
	[lukem, ticket #1294]

usr.bin/ftp/Makefile				1.39
usr.bin/ftp/ssl.c				1.10
usr.bin/ftp/ssl.h				1.5
usr.bin/ftp/version.h				1.93

	ftp(1): PR 56219: in crunched builds (e.g. some install media)
	use fetch_* functions for I/O.
	Set version to 20210603.
	[lukem, ticket #1295]

sys/kern/vfs_lookup.c				1.226
sys/kern/vfs_vnops.c				1.215
sys/sys/namei.src				1.59 (patch)
sys/rump/include/rump/rump_namei.h		(regen)
sys/sys/namei.h					(regen)

	Add a new namei flag NONEXCLHACK for open with O_CREAT and not O_EXCL.
	In the case where that target is the root, or a mount
	point, such that there's no parent dir, "real" CREATE operations fail,
	but O_CREAT without O_EXCL needs to succeed.
	Fixes newer Samba usage of /proc/self/fd/NNN with O_CREAT.
	[dholland, ticket #1296]

external/bsd/libarchive/dist/cat/test/test_0.c			up to 1.2
external/bsd/libarchive/dist/cpio/test/test_basic.c		up to 1.2
external/bsd/libarchive/dist/cpio/test/test_format_newc.c	up to 1.3
external/bsd/libarchive/dist/libarchive/archive_read.c		up to 1.2
external/bsd/libarchive/dist/libarchive/archive_read_disk_posix.c	up to 1.2
external/bsd/libarchive/dist/libarchive/archive_read_open_filename.c	up to 1.2
external/bsd/libarchive/dist/libarchive/archive_read_support_format_xar.c	up to 1.2
external/bsd/libarchive/dist/libarchive/archive_write_disk_posix.c	up to 1.6
external/bsd/libarchive/dist/libarchive/test/test_acl_platform_nfs4.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_acl_platform_posix1e.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_compat_zip.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_fuzz.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_extract.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_format_gtar_sparse.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_format_zip.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_format_zip_7075_utf8_paths.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_format_zip_comment_stored.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_format_zip_extra_padding.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_format_zip_high_compression.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_format_zip_jar.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_format_zip_mac_metadata.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_format_zip_malformed.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_format_zip_msdos.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_format_zip_nested.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_format_zip_nofiletype.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_format_zip_padded.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_format_zip_sfx.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_format_zip_with_invalid_traditional_eocd.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_format_zip_zip64.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_pax_truncated.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_read_truncated_filter.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_sparse_basic.c	up to 1.3
external/bsd/libarchive/dist/libarchive/test/test_write_disk.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_write_disk_secure.c	up to 1.4
external/bsd/libarchive/dist/libarchive/test/test_write_format_cpio_empty.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_write_format_shar_empty.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_write_format_tar.c	up to 1.2
external/bsd/libarchive/dist/libarchive/test/test_write_format_tar_sparse.c	up to 1.2
external/bsd/libarchive/dist/tar/write.c			up to 1.3
external/bsd/libarchive/dist/tar/test/test_basic.c		up to 1.2
external/bsd/libarchive/dist/tar/test/test_copy.c		up to 1.3
external/bsd/libarchive/dist/tar/test/test_option_C_upper.c	up to 1.2
external/bsd/libarchive/dist/tar/test/test_option_s.c		up to 1.2
external/bsd/libarchive/dist/test_utils/test_common.h		up to 1.2
external/bsd/libarchive/dist/test_utils/test_main.c		up to 1.2

	PR 56257: sync libarchive with -current, leaving out extended
	attributes and changes for newer gcc not relevant for this
	branch.
	[christos, ticket #1297]

lib/libc/gen/setjmp.3				1.18

	Clarify what happens when you longjmp(..., 0).
	[riastradh, ticket #1298]

sys/kern/kern_ksyms.c				1.90-1.97

	ksyms(4): Fix races and allow multiple concurrent opens.
	[riastradh, ticket #1299]

sys/external/bsd/drm2/dist/drm/i915/i915_drv.h	1.33 (patch)

	i915drmkms: Fix LOCKDEBUG panic and potential deadlock.
	[riastradh, ticket #1300]

sys/dev/usb/xhci.c				1.139-1.141,1.143 (patch)
sys/dev/usb/xhcireg.h				1.19 (patch)
sys/dev/usb/xhcivar.h				1.18,1.19 (patch)

	xhci(4): support suspend/resume.
	[riastradh, ticket #1301]

sys/dev/usb/ualea.c				1.13

	ualea(4): suport suspend/resume.
	[riastradh, ticket #1302]

sys/arch/x86/pci/dwiic_pci.c			1.5 (patch)

	dwiic(4): Attribute output correctly and relegate to debug-level.
	[riastradh, ticket #1303]

sys/dev/ld.c					1.112
sys/dev/ldvar.h					1.35

	ld(4): fix suspend/resume.
	[riastradh, ticket #1304]

sys/dev/ic/nvme.c				1.56,1.57
sys/dev/ic/nvmevar.h				1.22
sys/dev/pci/nvme_pci.c				1.30

	nvme(4): add suspend/resume.
	[riastradh, ticket #1305]

sys/dev/usb/umass.c				1.185
sys/dev/usb/umass_scsipi.c			1.68

	umass(4): fix suspend/resume.
	[riastradh, ticket #1306]

sys/arch/amd64/amd64/db_disasm.c		1.28
sys/arch/i386/i386/db_disasm.c			1.49

	ddb(4) on amd64 and i386: don't go out of the way to detect
	invalid addresses. Fixes a double fault in ddb when a NULL function
	pointer is called.
	[riastradh, ticket #1307]

sys/arch/amd64/conf/GENERIC			1.581

	Enable tpm at acpi.
	[riastradh, ticket #1308]

compat/arm/oabi/bsd.oabi.mk		(apply patch)

	Fix PR 50192.
	[mrg, ticket #1309]

distrib/miniroot/install.sub			1.61,1.62
distrib/sun2/miniroot/Makefile			1.40
distrib/sun3/miniroot/Makefile			1.50

	Fixes to sun2 and sun3 miniroot upgrade scripts:
	- Replace RELEASE and VERSION strings proplery.
	- Remove netstat(1) calls to print resolver info on upgrade using
	  miniroot, the binary is not available.
	- The modules and rescue sets are also required on upgrade.
	[tsutsui, ticket #1310]

sys/dev/ic/ax88190.c				1.18
sys/dev/ic/dl10019.c				1.17
sys/dev/ic/dp8390.c				1.99

	Make sure the media / mii members in struct ethercom are initialized
	so that the media-related ioctls work.
	[thorpej, ticket #1311]

sys/miscfs/kernfs/kernfs_vnops.c		1.169,1.170

	Add missing VOP_KQFILTER to kernfs.
	Fix permissons on /kern/{r,}rootdev.
	[dholland, ticket #1318]

sys/arch/hppa/hppa/intr.c			1.4

	Fix off by one which resulted in all idle time reported as interrupt
	time.
	[macallan, ticket #1312]

common/lib/libc/arch/arm/atomic/atomic_add_64.S	1.12
common/lib/libc/arch/arm/atomic/atomic_and_64.S	1.11
common/lib/libc/arch/arm/atomic/atomic_cas_8.S	1.8
common/lib/libc/arch/arm/atomic/atomic_nand_64.S 1.5
common/lib/libc/arch/arm/atomic/atomic_or_64.S	1.12
common/lib/libc/arch/arm/atomic/atomic_sub_64.S	1.3
common/lib/libc/arch/arm/atomic/atomic_swap_64.S 1.13
common/lib/libc/arch/arm/atomic/atomic_xor_64.S	1.5

	Whitespace fixes to help later pullups.
	[skrll, ticket #1313]

common/lib/libc/arch/aarch64/atomic/atomic_nand_16.S 1.3
common/lib/libc/arch/aarch64/atomic/atomic_nand_32.S 1.3
common/lib/libc/arch/aarch64/atomic/atomic_nand_32.S 1.4
common/lib/libc/arch/aarch64/atomic/atomic_nand_64.S 1.3
common/lib/libc/arch/aarch64/atomic/atomic_nand_64.S 1.4
common/lib/libc/arch/aarch64/atomic/atomic_nand_8.S 1.3
common/lib/libc/arch/aarch64/atomic/atomic_nand_8.S 1.4

	Fix the logic operation for atomic_nand_{8,16,32,64}.
	[skrll, ticket #1314]

external/cddl/osnet/sys/kern/printf.c		1.3

	Use vpanic, not vprintf and then panic.
	[riastradh, ticket #1315]

external/cddl/osnet/dist/uts/common/dtrace/dtrace.c 1.41

	Remove a pointless printf.
	[riastradh, ticket #1316]

external/cddl/osnet/dist/uts/common/fs/zfs/zfs_vnops.c 1.71 (patch)
sys/rump/librump/rumpkern/vm.c			1.191 (patch)
sys/rump/librump/rumpvfs/vm_vfs.c		1.39-1.41 (patch)
sys/uvm/uvm_anon.c				1.80 (patch)
sys/uvm/uvm_page.c				1.248 (patch)
sys/uvm/uvm_pager.c				1.130 (patch)
tests/rump/rumpkern/t_vm.c			1.5,1.6 (patch)

	PR 55702, PR 55945: fix uvm pageout crashes.
	[riastradh, ticket #1317]

common/lib/libc/arch/aarch64/atomic/atomic_nand_16.S 1.4

	Cosmetics (to help later additional pullups)
	[skrll, ticket #1319]

sys/external/bsd/drm2/linux/linux_reservation.c	1.12

	drm: Release fence after use.
	[riastradh, ticket #1320]

sys/rump/librump/rumpvfs/vm_vfs.c		(apply patch)

	Adapt the uvm pageout changes to the branch.
	[chs, ticket #1321]

sys/arch/hppa/dev/sti_sgc.c			1.3

	PR 52162: Fix silent freeze on probing sti(4) framebuffer on 712/60.
	[tsutsui, ticket #1322]

etc/etc.hp300/MAKEDEV.conf			1.15
sys/arch/hp300/dev/ct.c				1.62,1.63
sys/arch/hp300/dev/ctreg.h			1.11
sys/arch/hp300/dev/hpib.c			1.43 (patch)
sys/arch/hp300/dev/hpibvar.h			1.22-1.24
sys/arch/hp300/dev/mt.c				1.55
sys/arch/hp300/dev/rd.c				1.103-1.109
sys/arch/hp300/dev/rdreg.h			1.14-1.17
sys/arch/hp300/dev/rdvar.h			1.24-1.26
sys/arch/hp300/stand/Makefile.buildboot		1.37
sys/arch/hp300/stand/common/ct.c		1.8
sys/arch/hp300/stand/common/hpibvar.h		1.6
sys/arch/hp300/stand/common/rd.c		1.11

	hp300: various rd(4) improvements.
	[tsutsui, ticket #1323]

sys/arch/arm/rockchip/rk_anxdp.c		1.4

	Fix display init on Pinebook Pro w/ U-Boot 2021.07.
	[jmcneill, ticket #1324]

sys/dev/audio/audio.c				1.105

	AUDIO_SETINFO: fix a bug that the gain and the balance could
	not be set at the same time.  PR kern/56308.
	[isaki, ticket #1325]

distrib/sets/lists/man/mi			1.1724
share/man/man4/man4.x86/Makefile		1.23 via patch
share/man/man4/man4.x86/amdccp.4		1.1

	Add a man page for amdccp(4)
	[nia, ticket #1326]

sys/external/bsd/drm2/linux/linux_reservation.c	1.13,1.14

	drm: fix more drm memory leaks.
	[riastradh, ticket #1327]

lib/libc/compiler_rt/Makefile.inc		1.40
lib/libm/compiler_rt/Makefile.inc		1.11
sys/external/bsd/compiler_rt/abi.mk		1.1
sys/external/bsd/compiler_rt/dist/lib/builtins/adddf3.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/addsf3.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/arm/aeabi_cdcmpeq_check_nan.c 1.2
sys/external/bsd/compiler_rt/dist/lib/builtins/arm/aeabi_cfcmpeq_check_nan.c 1.2
sys/external/bsd/compiler_rt/dist/lib/builtins/arm/aeabi_div0.c 1.2
sys/external/bsd/compiler_rt/dist/lib/builtins/arm/aeabi_drsub.c 1.2
sys/external/bsd/compiler_rt/dist/lib/builtins/arm/aeabi_frsub.c 1.2
sys/external/bsd/compiler_rt/dist/lib/builtins/ashldi3.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/ashrdi3.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/comparedf2.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/comparesf2.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/divdf3.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/divsf3.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/divsi3.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/extendhfsf2.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/extendsfdf2.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/fixdfdi.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/fixdfsi.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/fixsfdi.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/fixsfsi.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/fixunsdfdi.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/fixunsdfsi.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/fixunssfdi.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/fixunssfsi.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/floatdidf.c 1.3-1.5
sys/external/bsd/compiler_rt/dist/lib/builtins/floatdisf.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/floatsidf.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/floatsisf.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/floatundidf.c 1.3,1.4
sys/external/bsd/compiler_rt/dist/lib/builtins/floatundisf.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/floatunsidf.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/floatunsisf.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/int_lib.h 1.2-1.6
sys/external/bsd/compiler_rt/dist/lib/builtins/lshrdi3.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/muldf3.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/muldi3.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/mulsf3.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/negdf2.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/negsf2.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/subdf3.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/subsf3.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/truncdfhf2.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/truncdfsf2.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/truncsfhf2.c 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/udivsi3.c 1.2,1.3
sys/lib/libkern/Makefile.compiler-rt		1.13

	arm: PR 55897: fix various complex arithmetics issues by cherry
	picking the relevant upstream changes.
	[skrll, ticket #1328]

lib/libc/arch/arm/gen/swapcontext.S		1.16-1.18
lib/libc/arch/arm/sys/__clone.S			1.10-1.14
sys/external/bsd/compiler_rt/dist/lib/builtins/arm/aeabi_cfcmp.S 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/arm/divmodsi4.S 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/arm/divsi3.S 1.2,1.3
sys/external/bsd/compiler_rt/dist/lib/builtins/arm/modsi3.S 1.2,1.3

	arm: align stack pointer to 8-byte boundary as required by EABI.
	[skrll, ticket #1329]

