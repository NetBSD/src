# $NetBSD: CHANGES-5.0.1,v 1.1.2.24 2009/06/17 21:34:45 bouyer Exp $

A complete list of changes from the NetBSD 5.0 release to the NetBSD 5.0.1
release:

gnu/usr.bin/groff/tmac/mdoc.local		patched by hand
sys/sys/param.h					patched by hand

	Welcome to 5.0.0_PATCH.
	[snj]

sys/kern/uipc_socket.c				1.189

	PR kern/41311: Mutex error: mutex_vector_enter: locking against myself
	[ad, ticket #731]

sys/dev/ic/ncr53c9x.c				1.138

	Add missing braces - patch from Kurt Lidl in PR port-vax/41314.
	[martin, ticket #734]

sys/netinet6/ip6_input.c			1.127

	Add missing paranthesis - from Kurt Lidl in PR port-vax/41316
	[martin, ticket #733]

gnu/dist/binutils/bfd/elf32-vax.c		1.9

	Allocate relocation section using bfd_zalloc() to ensure no garbage
	relocations when not all the entries are used.
	Fixes PR port-vax/39182.
	[mhitch, ticket #738]

sys/ufs/ffs/ffs_alloc.c				1.123 via patch

	Fix random 'filesystem full' messages by trapping a couple of
	32-bit overflow areas missed in rev 1.110 and switching cgbase().
	[sborrill, ticket #726]

usr.sbin/racoonctl/Makefile			1.5 via patch

	Adjust the ADMINPORTDIR to match that of racoon (with which it'll
	want to talk).  Fixes PR 41376.
	[spz, ticket #740]

sys/arch/hp700/include/intr.h			1.14

	Add __insn_barrier after updating cpl in splraise. PR/41369.
	[skrll, ticket #741]

sys/arch/m68k/include/psl.h			1.14

	Add memory clobber to the instructions that change the IPL in the
	status register.  See also kern/38637.
	[mhitch, ticket #743]

sys/netinet/in_pcb.c				patch

	Fix compilation with IPNOPRIVPORTS option.
	[sborrill, ticket #745]

share/man/man8/afterboot.8			1.39

	Fix typo, from Shannon -jj Behrens in PR 41375.
	[dholland, ticket #746]

sys/dist/ipf/netinet/ip_fil_netbsd.c		1.50

	Don't call callout_stop() without callout_init()
	Fixes PR/41364
	[kefren, ticket #748]

sys/arch/sparc/include/math.h			1.5
sys/arch/sparc64/include/math.h			1.7

	merge these two files, makes sparc64 sparc/libc work again.
	only provide __HAVE_LONG_DOUBLE if _LP64.
	[mrg, ticket #750]

sys/arch/amd64/amd64/lock_stubs.S		1.22, 1.23
sys/arch/i386/i386/lock_stubs.S			1.23
sys/arch/x86/include/mutex.h			1.6
sys/arch/x86/x86/patch.c			1.18
sys/kern/kern_rwlock.c				1.30

	Add a workaround for a bug with some Opteron revisions where
	locked operations sometimes do not serve as memory barriers,
	allowing memory references to bleed outside of critical sections.
	[ad, ticket #725]

usr.sbin/postinstall/postinstall		1.95

	Teach postinstall about /etc/dhcpcd.conf.
	[jnemeth, ticket #752]

usr.sbin/postinstall/postinstall		1.97

	Fetch /etc/dhcpcd.conf from the correct place when building the
	system from source.
	[jnemeth, ticket #756]

sys/kern/sys_mqueue.c				1.17

	sys_mq_open: remove broken access flag check.
	Noted by Stathis Kamperis.
	[rmind, ticket #762]

usr.sbin/schedctl/schedctl.c			1.14

	Skip LSIDL and LSZOMB threads when retrieving info.
	[rmind, ticket #763]

sys/arch/sparc/include/psl.h			1.45

	Add memory clobbers to the inline assembler modifying/testing the %psr
	register, to avoid the compiler reordering instructions out of critical
	sections. Should fix PR port-sparc/41372.
	[martin, ticket #764]

share/man/man7/sysctl.7				1.22 via patch

	Document PROC_PID_LIMIT_SBSIZE.  From Greg A. Woods in PR lib/36463.
	Wording is taken from getrlimit(2).
	[snj, ticket #765]

sys/arch/vax/include/mtpr.h			1.21, 1.22

	Add "memory" clobber to mtpr for barrier.  See also kern/38637.
	[mhitch, ticket #767]

dist/ntp/ntpd/ntp_crypto.c			1.15

	Fix CVE-2009-1252: Buffer overflow in ntpd crypto code. A remote
	attacker can send a specially constructed request packet that
	would overflow the sprintf()'ed buffer causing ntpd to crash.
	[dholland, ticket #777]

sys/arch/sparc64/sparc64/vm_machdep.c		1.88

	When preparing the initial trap frame for a new forked lwp,
	explicitly clear condition code. Otherwise we might catch a signal
	(handlers are inherited from the parent) before we ever return to
	userland. The current trapframe is converted into a ucontext and
	after the signal handler returns, the lwp stays in userland and
	directly uses the ucontext to return to the fork call.
	Fixes PR 41302.
	[martin, ticket #774]

sys/kern/sys_mqueue.c				1.18

	- Slightly rework the way permissions are checked. Neither
	mq_receive() nor mq_send() should fail due to permissions.
	- Check for empty message queue name (POSIX does not allow this
	for regular files, and it's weird), check for DTYPE_MQUEUE, fix
	permission check in mq_unlink(), clean up.
	[rmind, ticket #779]

sys/kern/kern_physio.c				1.91

	Remove a race where physio_done() may use memory already
	freed.  Fixes PR kern/39536.
	[hannken, ticket #781]

src/external/bsd/fetch/dist/libfetch/common.c	libfetch-2-23
src/external/bsd/fetch/dist/libfetch/common.h	libfetch-2-23
src/external/bsd/fetch/dist/libfetch/errlist.sh	libfetch-2-23
src/external/bsd/fetch/dist/libfetch/fetch.3	libfetch-2-23
src/external/bsd/fetch/dist/libfetch/fetch.c	libfetch-2-23
src/external/bsd/fetch/dist/libfetch/fetch.cat3	libfetch-2-23
src/external/bsd/fetch/dist/libfetch/fetch.h	libfetch-2-23
src/external/bsd/fetch/dist/libfetch/file.c	libfetch-2-23
src/external/bsd/fetch/dist/libfetch/ftp.c	libfetch-2-23
src/external/bsd/fetch/dist/libfetch/ftp.errors	libfetch-2-23
src/external/bsd/fetch/dist/libfetch/http.c	libfetch-2-23
src/external/bsd/fetch/dist/libfetch/http.errors libfetch-2-23

	Pull up libfetch-2.23:
	- if-not-modified support
	- document that struct URL is not part of the ABI
	- fetchRestartCalls cleanup for signal handlers
	- allow HTTP basic auth to be specified in the URL, allow : as part of
	  the cleartext password
	- fix a file descriptor leak in the file:// iteration code
	[joerg, ticket #670]

UPDATING					patch
distrib/sets/lists/base/mi			patch
distrib/sets/lists/etc/mi			patch
distrib/sets/lists/man/mi			patch
external/bsd/pkg_install/Makefile.inc		patch
external/bsd/pkg_install/prepare-import.sh	patch
external/bsd/pkg_install/dist/add/add.h		pkg_install-20090528
external/bsd/pkg_install/dist/add/main.c	pkg_install-20090528
external/bsd/pkg_install/dist/add/perform.c	pkg_install-20090528
external/bsd/pkg_install/dist/add/pkg_add.1	pkg_install-20090528
external/bsd/pkg_install/dist/admin/admin.h	pkg_install-20090528
external/bsd/pkg_install/dist/admin/audit.c	pkg_install-20090528
external/bsd/pkg_install/dist/admin/check.c	pkg_install-20090528
external/bsd/pkg_install/dist/admin/main.c	pkg_install-20090528
external/bsd/pkg_install/dist/admin/pkg_admin.1	pkg_install-20090528
external/bsd/pkg_install/dist/bpm/bpm.1		pkg_install-20090528
external/bsd/pkg_install/dist/create/build.c	pkg_install-20090528
external/bsd/pkg_install/dist/create/create.h	pkg_install-20090528
external/bsd/pkg_install/dist/create/main.c	pkg_install-20090528
external/bsd/pkg_install/dist/create/perform.c	pkg_install-20090528
external/bsd/pkg_install/dist/create/pkg_create.1 pkg_install-20090528
external/bsd/pkg_install/dist/create/pl.c	pkg_install-20090528
external/bsd/pkg_install/dist/create/util.c	pkg_install-20090528
external/bsd/pkg_install/dist/delete/pkg_delete.1 pkg_install-20090528
external/bsd/pkg_install/dist/info/info.h	pkg_install-20090528
external/bsd/pkg_install/dist/info/main.c	pkg_install-20090528
external/bsd/pkg_install/dist/info/perform.c	pkg_install-20090528
external/bsd/pkg_install/dist/info/pkg_info.1	pkg_install-20090528
external/bsd/pkg_install/dist/info/show.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/automatic.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/config.h.in	pkg_install-20090528
external/bsd/pkg_install/dist/lib/conflicts.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/decompress.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/dewey.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/fexec.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/file.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/global.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/iterate.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/lib.h		pkg_install-20090528
external/bsd/pkg_install/dist/lib/lpkg.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/opattern.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/pkg_io.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/pkg_summary.5	pkg_install-20090528
external/bsd/pkg_install/dist/lib/pkgdb.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/plist.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/str.c		pkg_install-20090528
external/bsd/pkg_install/dist/lib/var.c		pkg_install-20090528
external/bsd/pkg_install/dist/lib/version.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/version.h	pkg_install-20090528
external/bsd/pkg_install/dist/lib/vulnerabilities-file.c pkg_install-20090528
external/bsd/pkg_install/dist/admin/audit-packages.sh.in pkg_install-20090528
external/bsd/pkg_install/dist/admin/download-vulnerability-list.sh.in pkg_install-20090528
external/bsd/pkg_install/dist/delete/pkg_delete.c pkg_install-20090528
external/bsd/pkg_install/dist/lib/gpgsig.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/license.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/parse-config.c pkg_install-20090528
external/bsd/pkg_install/dist/lib/pkcs7.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/pkg_install.conf.5.in pkg_install-20090528
external/bsd/pkg_install/dist/lib/pkg_signature.c: pkg_install-20090528
external/bsd/pkg_install/dist/lib/remove.c	pkg_install-20090528
external/bsd/pkg_install/dist/lib/xwrapper.c	pkg_install-20090528
external/bsd/pkg_install/dist/x509/pkgsrc.cnf	pkg_install-20090528
external/bsd/pkg_install/dist/x509/pkgsrc.sh	pkg_install-20090528
external/bsd/pkg_install/dist/x509/signing.txt	pkg_install-20090528
external/bsd/pkg_install/lib/Makefile		patch
external/bsd/pkg_install/sbin/Makefile		patch
external/bsd/pkg_install/sbin/Makefile.inc	patch
external/bsd/pkg_install/sbin/pkg_add/Makefile	patch
external/bsd/pkg_install/sbin/pkg_admin/Makefile patch
external/bsd/pkg_install/sbin/pkg_create/Makefile patch
external/bsd/pkg_install/sbin/pkg_delete/Makefile patch
external/bsd/pkg_install/sbin/pkg_info/Makefile	patch
external/bsd/pkg_install/dist/add/extract.c	removed
external/bsd/pkg_install/dist/add/futil.c	removed
external/bsd/pkg_install/dist/add/verify.c	removed
external/bsd/pkg_install/dist/add/verify.h	removed
external/bsd/pkg_install/dist/admin/config.c	removed
external/bsd/pkg_install/dist/audit-packages/AUTHORS removed
external/bsd/pkg_install/dist/audit-packages/COPYING removed
external/bsd/pkg_install/dist/audit-packages/README removed
external/bsd/pkg_install/dist/audit-packages/audit-packages.1.in removed
external/bsd/pkg_install/dist/audit-packages/audit-packages.c removed
external/bsd/pkg_install/dist/audit-packages/audit-packages.conf.5.in removed
external/bsd/pkg_install/dist/audit-packages/audit-packages.conf.in removed
external/bsd/pkg_install/dist/audit-packages/download-vulnerability-list.1.in removed
external/bsd/pkg_install/dist/audit-packages/download-vulnerability-list.sh.in removed
external/bsd/pkg_install/dist/delete/delete.h	removed
external/bsd/pkg_install/dist/delete/main.c	removed
external/bsd/pkg_install/dist/delete/perform.c	removed
external/bsd/pkg_install/dist/lib/ftpio.c	removed
external/bsd/pkg_install/dist/lib/path.c	removed
external/bsd/pkg_install/dist/lib/path.h	removed
external/bsd/pkg_install/dist/lib/pen.c		removed
external/bsd/pkg_install/dist/lib/pexec.c	removed
external/bsd/pkg_install/dist/view/linkfarm.1	removed
external/bsd/pkg_install/dist/view/linkfarm.sh.in removed
external/bsd/pkg_install/dist/view/pkg_view.1	removed
external/bsd/pkg_install/dist/view/pkg_view.sh.in removed
external/bsd/pkg_install/sbin/audit-packages/Makefile removed
external/bsd/pkg_install/sbin/pkg_view/Makefile	removed

	Merge pkg_install-20090528 from HEAD.
	[joerg, ticket #784]

usr.sbin/puffs/mount_sysctlfs/sysctlfs.c	1.11

	Fix a crash while trying to read nodes on amd64, reported in
	PR/41494.
	[njoly, ticket #783]

sys/arch/sparc64/include/cpu.h			1.86
sys/arch/sparc64/sparc64/locore.s		1.291
sys/arch/sparc64/sparc64/vm_machdep.c		1.89

	cpu_setfunc() can not use lwp_trampoline, as that has additional
	lwp startup semantics. Use a simpler setfunc_trampoline instead.
	[martin, ticket #786]

sys/arch/m68k/include/m68k.h			1.14
sys/arch/m68k/m68k/switch_subr.s		1.22
sys/arch/m68k/m68k/vm_machdep.c			1.28

	Do not use lwp_trampoline for cpu_setfunc, we do not want to call
	lwp_startup() after a setfunc. Grow a simplified setfunc_trampoline
	instead.
	[martin, ticket #787]

sys/arch/hp700/hp700/locore.S			1.35
sys/arch/hp700/include/cpu.h			1.34
sys/arch/hppa/hppa/vm_machdep.c			1.36

	Do not use lwp_trampoline for cpu_setfunc, but a simplified
	setfunc_trampoline that does not call lwp_startup().
	[skrll, ticket #793]

distrib/common/parselist.awk			1.16
distrib/sets/maketars				1.66
share/dict/Makefile				1.17
share/mk/bsd.README				1.249
share/mk/bsd.hostprog.mk			1.55
share/mk/bsd.kmodule.mk				1.19
share/mk/bsd.lib.mk				1.298
share/mk/bsd.links.mk				1.34
share/mk/bsd.man.mk				1.100
share/mk/bsd.prog.mk				1.241
share/zoneinfo/Makefile				1.43
usr.bin/xinstall/xinstall.c			1.106 - 1.108 via patch

	Various METALOG fixes, including entries sorting to
	fix inconsistent shared sets among builds as seen in
	/pub/NetBSD-daily/netbsd-5/200904010000Z/shared/ and
	/pub/NetBSD-daily/netbsd-5/200904010002Z/shared/ dirs.
	Should fix PR 24457 and PR 41155.
	[snj, ticket #790]

sys/kern/sched_4bsd.c				1.25

	sched_pstats_hook: fix estcpu decay.
	this makes my desktop usable when running "make -j4".
	[rmind, ticket #791]

external/mit/xorg/server/drivers/xf86-video-s3/Makefile patch

	Add missing object file to build a properly working s3 module.
	Fixes PR xsrc/41206.
	[ahoka, ticket #795]

sys/arch/alpha/alpha/locore.s			1.114
sys/arch/alpha/alpha/vm_machdep.c		1.100
sys/arch/alpha/include/alpha.h			1.24

	Do not use lwp_trampoline for cpu_setfunc, but a simplified
	setfunc_trampoline that does not call lwp_startup() instead.
	[martin, ticket #798]

sys/arch/mips/include/locore.h			1.79
sys/arch/mips/mips/locore_mips1.S		1.65
sys/arch/mips/mips/mipsX_subr.S			1.28
sys/arch/mips/mips/mips_machdep.c		1.211
sys/arch/mips/mips/vm_machdep.c			1.123

	Do not use the same trampoline for cpu_lwp_fork and
	cpu_setfunc - only the former needs to call lwp_startup().
	[martin, ticket #799]

sys/arch/sparc/dev/zs.c				1.116

	Properly initialize child attach args to zero - we could end
	up with various devices having different ideas about being
	console otherwise.
	[martin, ticket #800]

sys/arch/powerpc/powerpc/locore_subr.S		1.38
sys/arch/powerpc/powerpc/vm_machdep.c		1.77

	Do not use the same trampoline for cpu_setfunc and
	cpu_lwp_fork, the latter does a lot more work.
	[martin, ticket #801]

share/man/man8/afterboot.8			1.40

	Make some updates (most notably syncing the Postfix section
	with reality). inspired by PR misc/39168.
	[snj, ticket #804]

sys/arch/sh3/sh3/locore_subr.S			1.52

	Fix logic error in copyinstr() when deciding whether to return EFAULT
	or ENAMETOOLONG.
	[uwe, ticket #802]

distrib/sets/lists/xbase/mi			1.76
external/mit/xorg/bin/xvidtune/Makefile		1.2

	fix xsrc/41577: install the Xvidtune app-defaults file, after the
	necessary preprocessing and sed processing it needs.
	[mrg, ticket #805]

sys/compat/linux/common/linux_socket.c		1.100

	In sendmsg(2), do copy the msghdr structure before trying to use it.
	[njoly, ticket #806]

sys/kern/subr_kobj.c				1.35

	Fix a crash observed when trying to load a corrupted ELF kernel module.
	[rmind, ticket #809]

sys/netinet/tcp_usrreq.c			1.155

	sysctl_inpcblist: fix a lock leak in error path
	[rmind, ticket #812]

sys/dev/pci/ehci_pci.c				1.45

	Apply hw workaround required for all SB600 revisions and SB700
	revisions A12 and A13 to avoid USB subsystem hang symptom.
	The USB subsystem hang symptom is observed when the system has
	multiple USB devices connected to it or one USB device is often
	re-connected.
	[cegger, ticket #814]

lib/libpam/modules/pam_unix/pam_unix.c		1.13

	Restore the good old UNIX behavior of root password changing: only root
	may change the root password.
	[tonnerre, ticket #817]

sys/kern/sys_generic.c				1.122 via patch

	Updates to f_flag need to be made with atomics.
	[rmind, ticket #811]

sys/kern/tty_pty.c				1.117

	Writes on the controlling tty were not being awoken from blocks,
	use the correct condvar to make this happen.
	this fixes PR/41566
	[plunky, ticket #807]

