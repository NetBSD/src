#	$NetBSD: CHANGES-4.0.2,v 1.1.2.31 2009/05/26 05:16:51 snj Exp $

A complete list of changes from the NetBSD 4.0.1 release to the NetBSD 4.0.2
release:

File						Revision(s)
----						--------
gnu/usr.bin/groff/tmac/mdoc.local		patch
sys/sys/param.h					patch

	Welcome to 4.0.1_PATCH

sys/arch/cobalt/conf/INSTALL                    1.32,1.35

        Enable bpfilter so that dhclient can work.  Allow root device to be
        detected, rather than hardcoding it to nfs.
        [tsutsui, ticket #1217]

doc/3RDPARTY                                    patch
distrib/sets/lists/base/mi                      1.773
share/zoneinfo/africa                           1.1.1.26
share/zoneinfo/asia                             1.1.1.43
share/zoneinfo/australasia                      1.17
share/zoneinfo/backward                         1.1.1.19
share/zoneinfo/europe                           1.1.1.38
share/zoneinfo/iso3166.tab                      1.1.1.17
share/zoneinfo/leapseconds                      1.1.1.15 
share/zoneinfo/northamerica                     1.1.1.42
share/zoneinfo/southamerica                     1.1.1.39,1.1.1.40
share/zoneinfo/zone.tab                         1.1.1.31

        Update to tzdata2008g.
        [jnemeth, ticket #1213]

share/man/man8/afterboot.8			1.35, 1.37, 1.38 via patch

	Fix reference to sshd_config and provide more information
	about DHCP.
	[tsutsui, ticket #1218]

distrib/notes/common/main			1.421
distrib/notes/common/sysinst			1.95
distrib/notes/i386/hardware			1.124
distrib/notes/mac68k/install			1.30

	Use `\*[Am]' rather than `\*&' for ampersand.
	[tsutsui, ticket #1219]

sys/arch/atari/dev/ncr5380.c                    1.56
 
	Fix hang when using SCSI devices on Atari Falcon and TT030.
	[abs, ticket #1222]
        
usr.bin/fsplit/fsplit.c				1.26 via patch

	Two robustness fixes:
	   (1) make ridiculously small filename buffer larger;
	   (2) don't accidentally try to generate files with names
	       containing '/'.
	[dholland, ticket #1238]

common/lib/libprop/prop_dictionary.c		1.33
common/lib/libprop/prop_number.c		1.20
common/lib/libprop/prop_object.c		1.23 via patch
common/lib/libprop/prop_object_impl.h		1.28

	Fix two race conditions in proplib.
	[haad, ticket #1243]

sys/dev/pci/if_wm.c				1.163

	Fixes nasty EEPROM-trashing bug on ich8 and ich9 chipsets
	as described in
	  http://mail-index.netbsd.org/current-users/2008/12/02/msg006435.html
	[sketch, ticket #1246]

sys/arch/atari/dev/clock.c			1.39
sys/arch/atari/include/param.h			1.31
	Simplify delay based on x86 version.
	[tsutsui, ticket #1253]

sys/arch/sparc/stand/bootblk/bootblk.fth	1.8

	Instead of bailing out with "Inode not directory", assume that
	the disk is a RAIDframe mirror, apply the RAID boot offset,
	and try to boot again.
	Fixes the problem where disks would be unbootable if partitioned
	normally and then converted to RAID 1 without being zeroed first.
	[jdc, ticket #1251]

lib/libc/gen/fts.c				1.35

	Ensure fts_close() doesn't spuriously close fd 0,
	by testing FTS_SYMFOLLOW in fts_flags instead of fts_options.
	Fix provided by Ben Harris in PR 40319
	[lukem, ticket #1256]

distrib/atari/floppies/common/dot.profile	1.3
distrib/atari/floppies/install/list		1.8
distrib/atari/floppies/prepare/install.md	1.3
distrib/atari/floppies/prepare/list		1.5
distrib/atari/miniroot/Makefile.inc		delete
distrib/atari/miniroot/disktab.shadow		delete
distrib/atari/miniroot/dot.profile		delete
distrib/atari/miniroot/install.md		delete
distrib/atari/miniroot/list			delete
distrib/atari/miniroot/termcap.vt		delete
sys/arch/atari/stand/installboot/installboot.c	1.21

	Since dl.d_type is always "unknown" now, pick the type of bootblock to
	install based on the device name: eg /dev/fd0c would be floppy
	Fix atari sysinst based miniroot image, and retire old (unreferenced)
	miniroot.
	[abs, ticket #1257]

usr.bin/make/make.1				1.151

	Fix blatantly wrong exposition of .WAIT example.
	PR bin/40372 from Gao Ya'nan.
	[dholland, ticket #1262]

sys/dev/pci/aac_pci.c				1.26

	Allocate enough space for the aac_pci_softc, not just the aac_softc.
	[briggs, ticket #1255]

share/misc/airport				1.31

	PR/40404 - Robert Elz -- Thailand airport updates
	[jnemeth, ticket #1265]

sys/arch/m68k/fpe/fpu_emulate.c			1.28

	In fpu_emul_arith(), check lower 7 bits in word1 rather than only
	6 bits to check 040/060 FP instructions, and don't call fpu_implode()
	and fpu_upd_fpsr() if no vaild emulated result is set otherwise these
	functions cause NULL pointer dereference.
	[tsutsui, ticket #1268]

usr.bin/locale/locale.c				1.7

	Fix off-by-one in malloc().
	[tnozaki, ticket #1269]

sbin/raidctl/raidctl.c				1.40

	Use correct format to print the "numBlocks" element in a RAIDframe
	component label. raidctl(8) should now print the correct number of
	blocks for RAID sets larger than 1TB.

	Patch supplied by Bernhard Moellemann in PR bin/40479.
	[tron, ticket #1270]

tools/compat/compat_defs.h			patch
tools/compat/configure				patch
tools/compat/configure.ac			patch
tools/compat/nbtool_config.h.in			patch

	Fix build on netbsd-5 amd64 hosts.
	[adrianp, ticket #1278]

sys/kern/init_sysctl.c				1.158

	always calculate "needed" for KERN_FILE2 calls.  this allows a caller
	to get an estimate of the needed space, like the intention is.
	[mrg, ticket #1287]

usr.sbin/pstat/pstat.c				1.113

	convert getfiles() to use KERN_FILE2 sysctl.
	Now it can survive "struct file" changing, as is upcoming.
	[mrg, ticket #1289]

share/man/man3/bits.3				1.3

	PR/39381 - Taylor R Campbell
	missing line break causing funny formatting
	[dholland, ticket #1293]

common/lib/libprop/prop_object.c		 patch

	Fix crash where user was able to crash proplib with trying to
	internalize bad xml file with non-existing data type e.g. <number>.
	[haad, ticket #1296]

sys/sys/file.h                                  patch
sys/kern/uipc_usrreq.c                          patch

        Avoid deep recursion and file descriptor exhaustion.
        1. unp_detach: go not call unp_gc directly for descriptors
        that are unixdomain sockets themselves. Instead mark them
        for cleanup during garbage collection.
        2. unp_gc: handle detach of descriptors that were marked earlier.
        3. prohibit transfer of descriptors within SCM_RIGHTS messages if
        (num_files_in_transit > maxfiles / unp_rights_ratio)
        [mlelstv, ticket #1303]

sys/dist/pf/net/pf.c				1.54

	Fix http://www.securityfocus.com/archive/1/502634.
	[christos, ticket #1305]

sys/arch/mvme68k/stand/Makefile.booters		1.18
sys/arch/mvme68k/stand/bootst/dev_tape.c	1.11
sys/arch/mvme68k/stand/bootst/version		1.5

	Fix for install/40961: The RAMDISK kernel has grown significantly
	since bootst was written. Grab 3MB of the kernel image from tape
	in hackprom_diskrd() instead of 2MB.
	Bump bootst version on account of the above fix.
	While here, use -Os instead of -O2 to compile mvme68k stand code.
	[scw, ticket #1304]

dist/ntp/ntpq/ntpq.c				1.12

	Fix CVE-2009-0159.
	[christos, ticket #1308]

lib/libc/db/btree/bt_split.c			1.19
lib/libc/db/hash/hash_buf.c			1.15, 1.16
lib/libc/db/mpool/mpool.c			1.19

	Avoid information leaks by zeroing memory.
	[christos, ticket #1310]

lib/libc/db/hash/hash_buf.c			1.17, 1.18

	Fix build fallout from ticket 1310
	[hauke, ticket #1311]

usr.sbin/racoonctl/Makefile			1.5 via patch

	adjust the ADMINPORTDIR to match that of racoon (with which
	it'll want to talk) fixes PR 41376
	[spz, ticket #1312]

lib/libc/stdio/vfwprintf.c			1.15

	printf("%zi\n", (ssize_t)-1); now correcly prints -1 on i386
	[cube, ticket #1313]

share/man/man8/afterboot.8			1.39

	Fix typo, from Shannon -jj Behrens in PR 41375.
	[dholland, ticket #1314]

sys/arch/sparc/include/psl.h			1.45

	Add memory clobbers to the inline assembler modifying/testing the %psr
	register, to avoid the compiler reordering instructions out of critical
	sections. Should fix PR port-sparc/41372.
	[martin, ticket #1317]

lib/libc/gen/sysctl.3				patch

	document PROC_PID_LIMIT_SBSIZE. Addresses PR 36463.
	[snj, ticket #1318]           

dist/ntp/ntpd/ntp_crypto.c			1.15

	Fix CVE-2009-1252: Buffer overflow in ntpd crypto code. A remote
	attacker can send a specially constructed request packet that
	would overflow the sprintf()'ed buffer causing ntpd to crash.
	[mrg, ticket #1320]

