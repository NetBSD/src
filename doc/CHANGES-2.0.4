#	$NetBSD: CHANGES-2.0.4,v 1.1.2.31 2006/05/24 02:38:43 riz Exp $

A complete list of changes from the NetBSD 2.0.3 update to the NetBSD 2.0.4
update.

File						Revision(s)
----						--------
sys/sys/param.h					patch

	Update to 2.0.3_STABLE

sys/arch/sparc/sparc/cpu.c			1.193

	Compute c_totalsize for split caches correctly: it's max, not sum (and
	we even have that documented in cache.h).  Initialize c_nlines for
	split caches.
	This should fix srmmu cache flush routines for split I/D caches that
	has been broken since cache.c revision 1.79 started using c_nlines.
	[uwe, ticket #5950]

sys/kern/uipc_socket.c				1.112

	Check the argument to SO_LINGER.
	[nathanw, ticket #5939]

sys/kern/kern_exec.c				patch

	Don't clear unconditionally P_SUGID when we exec. Clear it only when
	the real and effective user and group ids match.
	[dan, ticket #5955]

dist/ntp/ntpd/ntpd.c				1.8

	Use group-id from ``gr'' and not ``pw''.
	Fixes security issue addressed by CAN-2005-2496.
	[dan, ticket #5958]

sys/dev/scsipi/scsipi_ioctl.c			1.54

	Don't claim there is a data in or out phase if the datalen is 0
	(userland shouldn't claim it either, but a buggy software shouldn't
	be able to crash the kernel anyway). Should fix port-sparc64/31925
	by Johan A.van Zanten (which should really be kern/31925).
	Analysed and patch tested by Martin Husemann.
	[bouyer, ticket #5961]

distrib/utils/sysinst/util.c			1.137

	Don't redisplay the title messages before displaying sub-menus
	during set selection (eg selecting the X sets).
	libcurses got changed earlier in the year so that the erase (and
	refresh) of the message window caused all the unchanged spaces
	to be redrawn overwriting most of the main set selection window.
	[dsl, ticket #5964]

sys/uvm/uvm_glue.c				1.90

	Remove the assertion in uvm_swapout_threads() about LSONPROC lwps
	not running on the same CPU as the swapper.  l_stat is protected by
	sched_lock, which isn't held here, so we can race with that lwp
	starting to run and see its l_cpu not updated yet, as in PR 31870.
	we check l_stat again in uvm_swapout() while holding sched_lock,
	so the race itself is harmless.
	[bouyer, ticket #5965]

sbin/newfs/mkfs.c				1.92

	don't set fs_maxsymlinklen and fs_old_inodefmt twice,
	we set them correctly the first time.  fixes PR 26995.
	[chs, ticket #5971]

sys/kern/vfs_vnops.c				1.99

	vput() -> vrele(). Vnode is already unlocked.
	With much help from Pavel Cahyna.  PR#32005
	[hannken, ticket #5983]

sys/miscfs/kernfs/kernfs_vnops.c		1.114 via patch

	Fix 64 bit truncation problem allowing to read arbitrary kernel memory.
	[christos, ticket #10155]

sys/nfs/nfs_bio.c				1.136-1.137 via patch

	The problem (kern/31926): under certain conditions, which could be
	reliably reproduced, NFS reads would occasionally return zeroes instead
	of some of the file data, or fail with EINVAL.
	[jld, ticket #8826]

sbin/fdisk/fdisk.c				1.82 via patch

	Fix intuit_translated_geometry() calculation. PR#26917.
	[tsutsui, ticket #10165]

sys/dev/ic/an.c					1.33 via patch
sys/dev/ic/anvar.h				1.9 via patch

	Fix two bugs: frames were bogusly discarded with the complaint
	"oversize frame."  Also, some an(4) instances (esp. w/ firmware
	version 5+) would not reliably interoperate with some Cisco APs.
	Thanks to Jim Miller for his valuable bug reports and testing, and
	to Dheeraj Reddy for RID-length patches.
	[jnemeth, ticket #10159]

sys/kern/kern_time.c				patch

	Avoid time wrap when setting the system time.
	[christos, ticket #10184]

build.sh					patch

	Clean up environment to avoid side effects on builds.
	[jmc, ticket #10194]

distrib/notes/mac68k/prep			1.14

	Add text for workaround of sysinst not running newfs etc. PR#29049
	[hubertf, ticket #10198]

sys/dev/ic/aic79xx_osm.c			1.13-1.14
sys/dev/ic/aic7xxx_osm.c			1.19-1.20
sys/dev/ic/aic79xx.c				1.32
sys/dev/ic/aic79xxvar.h				1.20
sys/dev/ic/aic7xxx.c				1.117
sys/dev/ic/aic7xxx_inline.h			1.7
sys/dev/ic/aic7xxxvar.h				1.50

	Don't call alloc_scb() (which can call bus_dmamem_alloc/map) from
	ADAPTER_REQ_RUN_XFER context (which can be interrupt context), defer 
	this to the ADAPTER_REQ_GROW_RESOURCES callback. Fixes a panic in uvm.
	[bouyer, ticket #10177]

sys/kern/kern_sig.c				1.211

	in kpsignal2(), do not try to wake up a cached LWP for SA processes
	in the case where we're sending SIGKILL but all LWPs are not signalable.
	some LWP will wake up soon enough to process the signal, and there may
	not be any LWPs in the cache to wake up anyway.  fixes PR 28886 and
	PR 26771.  also, add a missing "break" pointed out by yamt.
	[chs, ticket #10206]

sys/kern/vfs_subr.c				1.231

	Fix an annoying deadlock involving 3 separate processes.
	[chs, ticket #10207]

sys/fs/union/union_vfsops.c			1.32 via patch

	Change union_unmount() to not play with the fs root vnode explicitly.
	Let it get recycled along with all of the others. This is important
	as if the root vnode has already been reclaimed, then we get a panic
	when we try to vget it.  This addresses PR: kern/31382
	[wrstuden, ticket #10213]

sys/net/if_bridge.c				1.35

	Make sure we initialize all structs to 0.
	[christos, ticket #10219]

crypto/dist/kame/racoon/isakmp_agg.c		patch

	Fix denial of service vulnerabilityin racoon(8).
	[adrianp, ticket #10224]

sys/uvm/uvm_amap.c				1.66 via patch

	Prevent occasional panics on machines which are low on memory.
	This fixes PR kern/25392, port-sparc/30257 and kern/31924.
	[chs, ticket #10230]

sys/net/if_bridge.c				1.36

	Fix memory disclosure in bridge(4).
	[adrianp, ticket #10306]

sys/arch/i386/pci/pchb_rnd.c			patch

	Improve code probing for the Intel hardware RNG to avoid false
	detections.
	[tron, ticket #10327]

usr.bin/login/login.c				1.87 via patch

	PR/31059: don't issue different message for root login on
	insecure terminal.
	[jnemeth, ticket #10356]

usr.bin/mail/send.c				1.24

	PR/32978: Johan Veenhuizen: mail(1) creates record file with
	insecure umask
	[adrianp, ticket #10365]

sys/kern/exec_elf32.c				1.110-1.111

	Found by coverity issue 887.  Check for NULL before using base_ph so
	an interpreter that does not have PT_LOAD in the program header doesn't
	crash the system.
	[erh, ticket #10380]

gnu/dist/sendmail/libsm/fflush.c		patch
gnu/dist/sendmail/libsm/local.h			patch
gnu/dist/sendmail/libsm/refill.c		patch
gnu/dist/sendmail/sendmail/collect.c		patch
gnu/dist/sendmail/sendmail/conf.c		patch
gnu/dist/sendmail/sendmail/deliver.c		patch
gnu/dist/sendmail/sendmail/headers.c		patch
gnu/dist/sendmail/sendmail/mime.c		patch
gnu/dist/sendmail/sendmail/parseaddr.c		patch
gnu/dist/sendmail/sendmail/savemail.c		patch
gnu/dist/sendmail/sendmail/sendmail.h		patch
gnu/dist/sendmail/sendmail/sfsasl.c		patch
gnu/dist/sendmail/sendmail/sfsasl.h		patch
gnu/dist/sendmail/sendmail/srvrsmtp.c		patch
gnu/dist/sendmail/sendmail/tls.c		patch
gnu/dist/sendmail/sendmail/usersmtp.c		patch
gnu/dist/sendmail/sendmail/util.c		patch
gnu/dist/sendmail/sendmail/version.c		patch

	Apply patch 8.12.11.p0 from sendmail.org, with local compile fixes.
	[christos, ticket #10383]

sys/kern/kern_sysctl.c				1.191

	Check the "oldlen" argument to sysctl(2) before passing it
	to vslock(9). This prevents a local DOS.
	[drochner, ticket #10381]

sys/netipsec/xform_esp.c			1.8

	FreeBSD SA-06:11 and CVE-2006-0905: update the replay sequence number
	or else the anti-reply technique won't work as expected.
	[rpaulo, ticket #10384]

sys/dev/ata/wd.c				patch

	sync the list of quirky seagate drives with -current.
	[bouyer, ticket #10397]

usr.sbin/rpc.statd/statd.c			1.27

	Use sigaction(2) to setup automatic disposal of child processes after
	daemonizing. This is more portable and avoids zombie "rpc.statd"
	processes after an NFS client running e.g. Mac OS X shuts down.
	[tron, ticket #10400]

sys/netinet/in.c				1.105

	Close NULL dereference when a GIFALIAS is performed on a
	non existant address.
	[seanb, ticket #10411]

games/sail/pl_main.c				1.17

	fix buffer overflow (CVE-2006-1744), from Debian
	[drochner, ticket #10504]

sys/arch/amd64/amd64/fpu.c			1.14-1.15
sys/arch/i386/isa/npx.c				1.112
sys/arch/xen/i386/npx.c				1.8

	Apply fix from FreeBSD's advisory: fxrstor on AMD FPU's does not
	restore FIP,FDP,FOP thus leaking other process's execution history.
	[adrianp, ticket #10553]

sys/dev/ata/wd.c				1.324 via patch

	Add yet another broken 160Gb seagate drive.
	[bouyer, ticket #10625]

sys/netinet6/ip6_input.c			1.87 via patch

	In ip6_savecontrol(), ignore IPv4 packets.
	From JINMEI Tatuya (KAME). PR#33269.
	[rpaulo, ticket #10626]

